<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Zed's Annotated Bibliography on Color</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.2/jspdf.umd.min.js"></script>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: serif; }
#header { padding: 10px; border-bottom: 1px solid #000; font-weight: bold; }
#main { display: flex; height: calc(100vh - 42px); }
#sidebar { width: 200px; min-width: 200px; border-right: 1px solid #000; padding: 10px; overflow-y: auto; display: flex; flex-direction: column; }
#sidebar-top { flex: 1; }
#sidebar-bottom { margin-top: 10px; border-top: 1px solid #ccc; padding-top: 10px; }
#sidebar a { display: block; margin-bottom: 6px; color: #000; cursor: pointer; }
#sidebar a:hover { text-decoration: underline; }
#sidebar a.active { font-weight: bold; }
.topic-count { color: #666; font-size: 0.85em; }
#content { flex: 1; padding: 10px; overflow-y: auto; position: relative; }
#content a { color: #000; cursor: pointer; }
#content a:hover { text-decoration: underline; }
.entry { margin-bottom: 12px; }
.short-summary { margin-left: 20px; margin-top: 2px; }
button { margin-top: 10px; cursor: pointer; font-family: serif; font-size: inherit; }
textarea { width: 100%; font-family: serif; font-size: inherit; margin-top: 4px; }
input[type="text"] { font-family: serif; font-size: inherit; }
.edit-section { margin-top: 16px; }
.edit-section label { display: block; margin-top: 10px; }
.search-bar { margin-bottom: 6px; }
.search-bar input { width: 300px; padding: 2px 4px; }
.sort-bar { margin-bottom: 8px; }
.sort-bar select { font-family: serif; font-size: inherit; }
.entry-url { margin-top: 4px; font-size: 0.9em; }
.entry-url a { color: #0066cc !important; }
.date-badge { color: #888; font-size: 0.85em; margin-left: 10px; }
@media print {
  #sidebar, #password-page, button, .search-bar, .sort-bar, .edit-section, #sidebar-bottom, #sidebar-logout, #sidebar-editor-controls, #sidebar-edit-area, #sidebar-remove-area { display: none !important; }
  #main { display: block !important; }
  #content { padding: 0 !important; overflow: visible !important; height: auto !important; }
  #header { border-bottom: 2px solid #000; margin-bottom: 12px; }
  body { font-size: 12pt; }
  a { text-decoration: none !important; color: #000 !important; }
}
</style>
</head>
<body>

<div id="password-page" style="padding: 10px;">
<div><b>Zed's Annotated Bibliography on Color</b></div>
<br><br>
<div>Enter password to access the read-only version of this site:</div>
<br>
<input type="password" id="password-readonly" style="font-family: serif; font-size: inherit;" onkeydown="if(event.key==='Enter')checkPasswordReadOnly()">
<button onclick="checkPasswordReadOnly()">Enter</button>
<div id="password-error-readonly" style="margin-top: 6px;"></div>
<br><br>
<div>Editor's access:</div>
<br>
<input type="password" id="password-editor" style="font-family: serif; font-size: inherit;" onkeydown="if(event.key==='Enter')checkPasswordEditor()">
<button onclick="checkPasswordEditor()">Enter</button>
<div id="password-error-editor" style="margin-top: 6px;"></div>
</div>

<div id="site" style="display:none;">
<div id="header">Zed's Annotated Bibliography on Color <span id="entry-count-header" style="font-weight:normal;"></span></div>

<div id="main">
<div id="sidebar">
<div id="sidebar-top">
<a onclick="showHome()">All Entries</a>
<a onclick="showRecentlyAdded()" style="font-size:0.9em;">Recently Added</a>
<a onclick="showUncategorized()" style="font-size:0.9em;">Uncategorized</a>
<a onclick="showStatistics()" style="font-size:0.9em;">Statistics</a>
<br>
<div style="margin-bottom:4px;"><b>Topics</b></div>
<div id="topic-links"></div>
<br>
<div id="sidebar-edit-area">
<button onclick="editTopics()">Edit</button>
<button onclick="removeTopicsUI()">Remove Topic</button>
<button onclick="bulkAddTopicsUI()">Bulk Add Topics</button>
</div>
<div id="sidebar-remove-area"></div>
<div id="sidebar-editor-controls">
<br>
<button onclick="undo()">Undo</button>
<br>
<button onclick="saveToGitHub()">Save to GitHub</button>
<div id="github-status" style="margin-top: 4px;"></div>
<br>
<button onclick="exportData()">Save to file</button>
<button onclick="document.getElementById('import-file').click()">Load from file</button>
<input type="file" id="import-file" accept=".json" style="display:none" onchange="importData(event)">
</div>
<br>
<span id="editor-export-btns"><button onclick="exportPDF()">Export summaries as PDF</button>
<button onclick="exportQuotationsPDF()">Export key quotations</button>
<button onclick="exportCompletePDF()">Export complete PDF</button></span>
<span id="import-bibtex-btn"><button onclick="document.getElementById('import-bibtex-file').click()">Import from BibTeX</button>
<input type="file" id="import-bibtex-file" accept=".bib,.bibtex,.txt" style="display:none" onchange="importBibTeX(event)"></span>
<button onclick="exportBibTeX()">Export as BibTeX</button>
</div>
<div id="sidebar-bottom">
<button onclick="changeEditorPasswordUI()">Change editor password</button>
<button onclick="changeReadonlyPasswordUI()">Change read-only password</button>
</div>
<div id="sidebar-logout" style="margin-top: 10px; border-top: 1px solid #ccc; padding-top: 10px;">
<button onclick="logOut()">Log Out</button>
</div>
</div>
<div id="content"></div>
</div>
</div>

<script>
// --- PASSWORD ---

function getCookie(name) {
  var match = document.cookie.match(new RegExp('(^| )' + name + '=([^;]+)'));
  return match ? match[2] : null;
}

function setCookie(name, value) {
  var d = new Date();
  d.setFullYear(d.getFullYear() + 100);
  document.cookie = name + "=" + value + ";expires=" + d.toUTCString() + ";path=/;SameSite=Lax";
}

var DEFAULT_PASSWORD = "Therainbow159!";
var DEFAULT_READONLY_PASSWORD = "Elephant2026%";
var readOnly = false;

function getStoredPassword() {
  if (typeof sitePassword !== "undefined" && sitePassword) return sitePassword;
  return DEFAULT_PASSWORD;
}

function getStoredReadonlyPassword() {
  if (typeof readonlyPassword !== "undefined" && readonlyPassword) return readonlyPassword;
  return DEFAULT_READONLY_PASSWORD;
}

function checkPasswordReadOnly() {
  loadData();
  var input = document.getElementById("password-readonly").value;
  if (input === getStoredReadonlyPassword()) {
    readOnly = true;
    setCookie("zed_biblio_auth", "readonly");
    enterSite();
  } else {
    document.getElementById("password-error-readonly").textContent = "Incorrect password.";
  }
}

function checkPasswordEditor() {
  loadData();
  var input = document.getElementById("password-editor").value;
  if (input === getStoredPassword()) {
    readOnly = false;
    setCookie("zed_biblio_auth", "editor");
    enterSite();
  } else {
    document.getElementById("password-error-editor").textContent = "Incorrect password.";
  }
}

var pwFormOpen = false;

function changeEditorPasswordUI() {
  var content = document.getElementById("content");
  if (pwFormOpen === "editor") {
    showHome();
    pwFormOpen = false;
    return;
  }
  pwFormOpen = "editor";
  content.innerHTML = '<div style="padding:10px;">' +
    '<b>Change Editor Password</b><br><br>' +
    '<div>Current editor password:</div>' +
    '<input type="password" id="current-pw" style="width:250px; font-family:serif; font-size:inherit; margin-top:4px;"><br>' +
    '<div style="margin-top:10px;">New editor password:</div>' +
    '<input type="password" id="new-pw" style="width:250px; font-family:serif; font-size:inherit; margin-top:4px;"><br>' +
    '<div style="margin-top:10px;">Confirm new editor password:</div>' +
    '<input type="password" id="confirm-pw" style="width:250px; font-family:serif; font-size:inherit; margin-top:4px;"><br><br>' +
    '<button onclick="saveEditorPassword()">Save</button> ' +
    '<button onclick="cancelPasswordChange()">Cancel</button>' +
    '<div id="pw-change-msg" style="margin-top:10px;"></div>' +
    '</div>';
}

function changeReadonlyPasswordUI() {
  var content = document.getElementById("content");
  if (pwFormOpen === "readonly") {
    showHome();
    pwFormOpen = false;
    return;
  }
  pwFormOpen = "readonly";
  content.innerHTML = '<div style="padding:10px;">' +
    '<b>Change Read-Only Password</b><br><br>' +
    '<div>Current read-only password:</div>' +
    '<input type="password" id="current-ro-pw" style="width:250px; font-family:serif; font-size:inherit; margin-top:4px;"><br>' +
    '<div style="margin-top:10px;">New read-only password:</div>' +
    '<input type="password" id="new-ro-pw" style="width:250px; font-family:serif; font-size:inherit; margin-top:4px;"><br>' +
    '<div style="margin-top:10px;">Confirm new read-only password:</div>' +
    '<input type="password" id="confirm-ro-pw" style="width:250px; font-family:serif; font-size:inherit; margin-top:4px;"><br><br>' +
    '<button onclick="saveReadonlyPassword()">Save</button> ' +
    '<button onclick="cancelPasswordChange()">Cancel</button>' +
    '<div id="pw-change-msg" style="margin-top:10px;"></div>' +
    '</div>';
}

function cancelPasswordChange() {
  pwFormOpen = false;
  showHome();
}

function logOut() {
  document.cookie = "zed_biblio_auth=;expires=Thu, 01 Jan 1970 00:00:00 UTC;path=/;SameSite=Lax";
  document.getElementById("site").style.display = "none";
  document.getElementById("password-page").style.display = "block";
  document.getElementById("password-readonly").value = "";
  document.getElementById("password-editor").value = "";
  document.getElementById("password-error-readonly").textContent = "";
  document.getElementById("password-error-editor").textContent = "";
  readOnly = false;
}

function saveEditorPassword() {
  var current = document.getElementById("current-pw").value;
  var newPw = document.getElementById("new-pw").value;
  var confirmPw = document.getElementById("confirm-pw").value;
  var msg = document.getElementById("pw-change-msg");

  if (current !== getStoredPassword()) {
    msg.textContent = "Current editor password is incorrect.";
    return;
  }
  if (newPw.length < 1) {
    msg.textContent = "New password cannot be empty.";
    return;
  }
  if (newPw !== confirmPw) {
    msg.textContent = "New passwords do not match.";
    return;
  }
  sitePassword = newPw;
  autoSave();
  msg.textContent = "Editor password changed. Save to GitHub to sync across devices.";
  setTimeout(function() {
    cancelPasswordChange();
  }, 2000);
}

function saveReadonlyPassword() {
  var current = document.getElementById("current-ro-pw").value;
  var newPw = document.getElementById("new-ro-pw").value;
  var confirmPw = document.getElementById("confirm-ro-pw").value;
  var msg = document.getElementById("pw-change-msg");

  if (current !== getStoredReadonlyPassword()) {
    msg.textContent = "Current read-only password is incorrect.";
    return;
  }
  if (newPw.length < 1) {
    msg.textContent = "New password cannot be empty.";
    return;
  }
  if (newPw !== confirmPw) {
    msg.textContent = "New passwords do not match.";
    return;
  }
  readonlyPassword = newPw;
  autoSave();
  msg.textContent = "Read-only password changed. Save to GitHub to sync across devices.";
  setTimeout(function() {
    cancelPasswordChange();
  }, 2000);
}

function enterSite() {
  document.getElementById("password-page").style.display = "none";
  document.getElementById("site").style.display = "block";
  loadFromGitHub(function() {
    applyAccessMode();
    renderSidebar();
    showHome();
  });
}

function applyAccessMode() {
  var hide = readOnly ? "none" : "";
  document.getElementById("sidebar-edit-area").style.display = hide;
  document.getElementById("sidebar-remove-area").style.display = hide;
  document.getElementById("sidebar-editor-controls").style.display = hide;
  document.getElementById("sidebar-bottom").style.display = hide;
  document.getElementById("import-bibtex-btn").style.display = hide;
  document.getElementById("editor-export-btns").style.display = hide;
}

var cookieVal = getCookie("zed_biblio_auth");
if (cookieVal === "editor" || cookieVal === "granted") {
  readOnly = false;
  enterSite();
} else if (cookieVal === "readonly") {
  readOnly = true;
  enterSite();
}

// =============================================================
// GITHUB CONFIGURATION
// =============================================================
var GITHUB_TOKEN = "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";
var GITHUB_REPO = "zedadams/color-bibliography";
var GITHUB_FILE = "data.json";

var githubSha = null;

function ghStatus(msg) {
  document.getElementById("github-status").textContent = msg;
}

function loadFromGitHub(callback) {
  if (GITHUB_TOKEN === "YOUR_TOKEN_HERE") {
    loadData();
    callback();
    return;
  }
  ghStatus("Loading...");
  fetch("https://api.github.com/repos/" + GITHUB_REPO + "/contents/" + GITHUB_FILE, {
    headers: { "Authorization": "token " + GITHUB_TOKEN }
  })
  .then(function(r) {
    if (r.status === 404) {
      ghStatus("No data on GitHub yet.");
      loadData();
      callback();
      return null;
    }
    return r.json();
  })
  .then(function(data) {
    if (!data) return;
    githubSha = data.sha;
    var content = atob(data.content.replace(/\n/g, ""));
    var parsed = JSON.parse(content);
    topics = parsed.topics || [];
    entries = parsed.entries || [];
    sitePassword = parsed.sitePassword || "Therainbow159!";
    readonlyPassword = parsed.readonlyPassword || "Elephant2026%";
    dismissedDuplicates = parsed.dismissedDuplicates || [];
    migrateEntries();
    autoSave();
    ghStatus("Loaded from GitHub.");
    callback();
  })
  .catch(function(err) {
    ghStatus("GitHub load failed, using local data.");
    loadData();
    callback();
  });
}

function saveToGitHub() {
  if (GITHUB_TOKEN === "YOUR_TOKEN_HERE") {
    ghStatus("Configure GitHub token first.");
    return;
  }
  ghStatus("Saving...");
  var content = btoa(unescape(encodeURIComponent(
    JSON.stringify({ topics: topics, entries: entries, sitePassword: sitePassword, readonlyPassword: readonlyPassword, dismissedDuplicates: dismissedDuplicates }, null, 2)
  )));
  var body = {
    message: "Update bibliography",
    content: content
  };
  if (githubSha) {
    body.sha = githubSha;
  }
  fetch("https://api.github.com/repos/" + GITHUB_REPO + "/contents/" + GITHUB_FILE, {
    method: "PUT",
    headers: {
      "Authorization": "token " + GITHUB_TOKEN,
      "Content-Type": "application/json"
    },
    body: JSON.stringify(body)
  })
  .then(function(r) { return r.json(); })
  .then(function(data) {
    if (data.content && data.content.sha) {
      githubSha = data.content.sha;
      ghStatus("Saved to GitHub.");
    } else {
      ghStatus("Error: " + (data.message || "unknown"));
    }
  })
  .catch(function(err) {
    ghStatus("Save failed: " + err.message);
  });
}

// --- DATA ---

var topics, entries, sitePassword, readonlyPassword, dismissedDuplicates;

// Migration: ensure entries have new fields (url, dateAdded, dateModified)
function migrateEntries() {
  var now = new Date().toISOString();
  for (var i = 0; i < entries.length; i++) {
    if (typeof entries[i].url === "undefined") entries[i].url = "";
    if (typeof entries[i].dateAdded === "undefined") entries[i].dateAdded = now;
    if (typeof entries[i].dateModified === "undefined") entries[i].dateModified = now;
    if (typeof entries[i].quotations === "undefined") entries[i].quotations = [];
    if (typeof entries[i].summaryHistory === "undefined") entries[i].summaryHistory = [];
    if (typeof entries[i].seeAlso === "undefined") entries[i].seeAlso = [];
    if (typeof entries[i].keywords === "undefined") entries[i].keywords = [];
    if (typeof entries[i].editorialNotes === "undefined") entries[i].editorialNotes = "";
  }
}

function loadData() {
  var saved = localStorage.getItem("zed_biblio_data");
  if (saved) {
    try {
      var data = JSON.parse(saved);
      topics = data.topics || [];
      entries = data.entries || [];
      sitePassword = data.sitePassword || "Therainbow159!";
      readonlyPassword = data.readonlyPassword || "Elephant2026%";
      dismissedDuplicates = data.dismissedDuplicates || [];
      migrateEntries();
      return;
    } catch (e) {}
  }
  // Default data if nothing saved
  sitePassword = "Therainbow159!";
  readonlyPassword = "Elephant2026%";
  dismissedDuplicates = [];
  topics = [
    { id: "abc", name: "ABC" },
    { id: "def", name: "DEF" },
    { id: "ghi", name: "GHI" }
  ];
  var now = new Date().toISOString();
  entries = [
    {
      id: "adams2015",
      citation: "Adams, Z. (2015). On the genealogy of color: A case study in historicized conceptual analysis. Routledge.",
      shortSummary: "JKL",
      longSummary: "PPP QQQ RRR",
      url: "",
      dateAdded: now,
      dateModified: now,
      topics: ["abc", "def"],
      quotations: [],
      summaryHistory: [], seeAlso: [], keywords: [], editorialNotes: ""
    },
    {
      id: "adams_hansen2020",
      citation: "Adams, Z., & Hansen, N. (2020). The myth of the common-sense conception of colour. Shifting concepts: The philosophy and psychology of conceptual variability, 106-127.",
      shortSummary: "MNO",
      longSummary: "SSS TTT UUU",
      url: "",
      dateAdded: now,
      dateModified: now,
      topics: ["def", "ghi"],
      quotations: [],
      summaryHistory: [], seeAlso: [], keywords: [], editorialNotes: ""
    }
  ];
}

function autoSave() {
  localStorage.setItem("zed_biblio_data", JSON.stringify({ topics: topics, entries: entries, sitePassword: sitePassword, readonlyPassword: readonlyPassword, dismissedDuplicates: dismissedDuplicates }));
}

// --- UNDO ---

var undoStack = [];
var MAX_UNDO = 50;

function snapshot() {
  undoStack.push(JSON.stringify({ topics: topics, entries: entries }));
  if (undoStack.length > MAX_UNDO) undoStack.shift();
}

function undo() {
  if (undoStack.length === 0) return;
  var prev = JSON.parse(undoStack.pop());
  topics = prev.topics;
  entries = prev.entries;
  migrateEntries();
  autoSave();
  renderSidebar();
  showHome();
}

loadData();

// --- NAVIGATION HISTORY ---

var navHistory = [];

function pushNav(fn) {
  navHistory.push(fn);
}

function goBack() {
  if (navHistory.length > 0) {
    var prev = navHistory.pop();
    prev();
  }
}

// --- SAVE / LOAD ---

function exportData() {
  var data = JSON.stringify({ topics: topics, entries: entries, sitePassword: sitePassword, readonlyPassword: readonlyPassword, dismissedDuplicates: dismissedDuplicates }, null, 2);
  var blob = new Blob([data], { type: "application/json" });
  var a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "bibliography.json";
  a.click();
}

function importData(event) {
  var file = event.target.files[0];
  if (!file) return;
  var reader = new FileReader();
  reader.onload = function(e) {
    try {
      var data = JSON.parse(e.target.result);
      snapshot();
      if (data.topics) topics = data.topics;
      if (data.entries) entries = data.entries;
      if (data.sitePassword) sitePassword = data.sitePassword;
      if (data.dismissedDuplicates) dismissedDuplicates = data.dismissedDuplicates;
      migrateEntries();
      autoSave();
      renderSidebar();
      showHome();
    } catch (err) {
      alert("Error reading file: " + err.message);
    }
  };
  reader.readAsText(file);
  event.target.value = "";
}

// --- RENDER SIDEBAR (Feature 1: entry counts per topic) ---

function sortTopics() {
  topics.sort(function(a, b) { return a.name.localeCompare(b.name); });
}

function countEntriesForTopic(topicId) {
  var count = 0;
  for (var i = 0; i < entries.length; i++) {
    if (entries[i].topics.indexOf(topicId) !== -1) count++;
  }
  return count;
}

function countUncategorized() {
  var count = 0;
  for (var i = 0; i < entries.length; i++) {
    if (entries[i].topics.length === 0) count++;
  }
  return count;
}

function renderSidebar() {
  sortTopics();
  var topicLinksDiv = document.getElementById("topic-links");
  topicLinksDiv.innerHTML = "";
  for (var i = 0; i < topics.length; i++) {
    var a = document.createElement("a");
    var count = countEntriesForTopic(topics[i].id);
    a.innerHTML = esc(topics[i].name) + ' <span class="topic-count">(' + count + ')</span>';
    a.setAttribute("data-topic", topics[i].id);
    (function(topicId) {
      a.onclick = function() { showTopic(topicId); };
    })(topics[i].id);
    topicLinksDiv.appendChild(a);
  }
  updateEntryCount();
}

function updateEntryCount() {
  var el = document.getElementById("entry-count-header");
  if (el) el.textContent = "(" + entries.length + " entr" + (entries.length === 1 ? "y" : "ies") + ")";
}

function editTopics() {
  var html = "";
  for (var i = 0; i < topics.length; i++) {
    html += '<div style="margin-bottom:4px">';
    html += '<input type="text" id="tname_' + i + '" value="' + escAttr(topics[i].name) + '" style="width:120px;">';
    html += '</div>';
  }
  html += '<br><a onclick="addTopicField()" style="font-size:small; cursor:pointer;">+ Add topic</a>';
  html += '<div id="new-topic-fields"></div>';
  html += '<br><button onclick="saveTopics()">Save</button> ';
  html += '<button onclick="cancelEditTopics()">Cancel</button>';
  document.getElementById("sidebar-edit-area").innerHTML = html;
}

var newTopicCount = 0;
function addTopicField() {
  var div = document.getElementById("new-topic-fields");
  var html = '<div style="margin-top:4px"><input type="text" id="tnew_' + newTopicCount + '" placeholder="New topic" style="width:120px;"></div>';
  div.innerHTML += html;
  newTopicCount++;
}

function saveTopics() {
  snapshot();
  for (var i = 0; i < topics.length; i++) {
    var input = document.getElementById("tname_" + i);
    if (input) topics[i].name = input.value;
  }
  for (var j = 0; j < newTopicCount; j++) {
    var input = document.getElementById("tnew_" + j);
    if (input && input.value.trim() !== "") {
      var newId = "topic_" + Date.now() + "_" + j;
      topics.push({ id: newId, name: input.value.trim() });
    }
  }
  newTopicCount = 0;
  autoSave();
  renderSidebar();
  cancelEditTopics();
}

function cancelEditTopics() {
  newTopicCount = 0;
  document.getElementById("sidebar-edit-area").innerHTML = '<button onclick="editTopics()">Edit</button><button onclick="removeTopicsUI()">Remove Topic</button><button onclick="bulkAddTopicsUI()">Bulk Add Topics</button>';
  document.getElementById("sidebar-remove-area").innerHTML = "";
}

function removeTopicsUI() {
  var html = '<div style="margin-top:6px">';
  html += '<label>Select topics to remove:</label><br><br>';
  for (var i = 0; i < topics.length; i++) {
    html += '<div style="margin-bottom:4px"><input type="checkbox" id="rt_' + i + '"> ' + esc(topics[i].name) + '</div>';
  }
  html += '<br><button onclick="saveRemoveTopics()">Remove Selected</button> ';
  html += '<button onclick="cancelRemoveTopics()">Cancel</button>';
  html += '</div>';
  document.getElementById("sidebar-remove-area").innerHTML = html;
}

function saveRemoveTopics() {
  snapshot();
  for (var i = topics.length - 1; i >= 0; i--) {
    var cb = document.getElementById("rt_" + i);
    if (cb && cb.checked) {
      var topicId = topics[i].id;
      topics.splice(i, 1);
      for (var j = 0; j < entries.length; j++) {
        var idx = entries[j].topics.indexOf(topicId);
        if (idx !== -1) entries[j].topics.splice(idx, 1);
      }
    }
  }
  autoSave();
  renderSidebar();
  cancelRemoveTopics();
  showHome();
}

function cancelRemoveTopics() {
  document.getElementById("sidebar-remove-area").innerHTML = "";
}

function bulkAddTopicsUI() {
  var html = '<div style="margin-top:6px">';
  html += '<label>Add multiple topics, one per line:</label>';
  html += '<textarea id="bulk-topics-input" rows="6" style="width:180px;" placeholder="Topic one\nTopic two\nTopic three"></textarea>';
  html += '<br><button onclick="saveBulkTopics()">Add All</button> ';
  html += '<button onclick="cancelBulkTopics()">Cancel</button>';
  html += '</div>';
  document.getElementById("sidebar-remove-area").innerHTML = html;
}

function saveBulkTopics() {
  var text = document.getElementById("bulk-topics-input").value;
  var lines = text.split("\n");
  var count = 0;
  snapshot();
  for (var i = 0; i < lines.length; i++) {
    var name = lines[i].trim();
    if (name === "") continue;
    topics.push({ id: "topic_" + Date.now() + "_" + i, name: name });
    count++;
  }
  if (count > 0) {
    autoSave();
    renderSidebar();
  }
  cancelBulkTopics();
}

function cancelBulkTopics() {
  document.getElementById("sidebar-remove-area").innerHTML = "";
}

// --- HELPER ---

function esc(str) {
  var div = document.createElement("div");
  div.textContent = str || "";
  return div.innerHTML;
}

function escAttr(str) {
  return (str || "").replace(/&/g, '&amp;').replace(/"/g, '&quot;').replace(/'/g, '&#39;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
}

// Feature 4 helper: extract year from "(YYYY)" in citation
function extractYear(citation) {
  var match = citation.match(/\((\d{4})\)/);
  return match ? parseInt(match[1]) : 0;
}

// Feature 7 helper: format ISO date for display
function formatDate(isoStr) {
  if (!isoStr) return "";
  var d = new Date(isoStr);
  var months = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
  return months[d.getMonth()] + " " + d.getDate() + ", " + d.getFullYear();
}

// --- VIEWS ---

function clearActive() {
  var links = document.querySelectorAll("#sidebar a");
  for (var i = 0; i < links.length; i++) links[i].className = "";
}

// Feature 2: Full-text search across citation + short summary + long summary
function filterEntries() {
  var authorVal = document.getElementById("search-author").value.toLowerCase().trim();
  var termVal = document.getElementById("search-term").value.toLowerCase().trim();
  var summaryVal = document.getElementById("search-summaries").value.toLowerCase().trim();
  var kwEl = document.getElementById("search-keywords");
  var kwVal = kwEl ? kwEl.value.toLowerCase().trim() : "";
  var yearFromEl = document.getElementById("year-from");
  var yearToEl = document.getElementById("year-to");
  var yearFrom = yearFromEl ? parseInt(yearFromEl.value) : NaN;
  var yearTo = yearToEl ? parseInt(yearToEl.value) : NaN;
  var isFiltering = authorVal !== "" || termVal !== "" || summaryVal !== "" || kwVal !== "" || !isNaN(yearFrom) || !isNaN(yearTo);

  var headings = document.querySelectorAll(".letter-heading");
  for (var h = 0; h < headings.length; h++) {
    headings[h].style.display = isFiltering ? "none" : "";
  }
  var spacer = document.querySelector(".bottom-spacer");
  if (spacer) spacer.style.display = isFiltering ? "none" : "";

  var divs = document.querySelectorAll(".entry-item");
  for (var i = 0; i < divs.length; i++) {
    var citation = (divs[i].getAttribute("data-citation") || "").toLowerCase();
    var fullText = (divs[i].getAttribute("data-fulltext") || "").toLowerCase();
    var summaryText = (divs[i].getAttribute("data-summarytext") || "").toLowerCase();
    var keywordsText = (divs[i].getAttribute("data-keywords") || "").toLowerCase();
    var entryYear = parseInt(divs[i].getAttribute("data-year") || "0");
    var authorMatch = true;
    var termMatch = true;
    var summaryMatch = true;
    var kwMatch = true;
    var yearMatch = true;
    if (authorVal) {
      var lastName = citation.split(",")[0].trim();
      authorMatch = lastName.indexOf(authorVal) !== -1;
    }
    if (termVal) {
      termMatch = citation.indexOf(termVal) !== -1;
    }
    if (summaryVal) {
      summaryMatch = summaryText.indexOf(summaryVal) !== -1;
    }
    if (kwVal) {
      kwMatch = keywordsText.indexOf(kwVal) !== -1;
    }
    if (!isNaN(yearFrom) || !isNaN(yearTo)) {
      if (entryYear === 0) {
        yearMatch = false;
      } else {
        if (!isNaN(yearFrom) && entryYear < yearFrom) yearMatch = false;
        if (!isNaN(yearTo) && entryYear > yearTo) yearMatch = false;
      }
    }
    divs[i].style.display = (authorMatch && termMatch && summaryMatch && kwMatch && yearMatch) ? "" : "none";
  }
}

function searchQuotations() {
  var val = document.getElementById("search-quotations").value.toLowerCase().trim();
  var resultsDiv = document.getElementById("quotation-search-results");
  if (val === "") {
    resultsDiv.innerHTML = "";
    return;
  }
  var html = "";
  var count = 0;
  for (var i = 0; i < entries.length; i++) {
    var entry = entries[i];
    if (!entry.quotations) continue;
    for (var q = 0; q < entry.quotations.length; q++) {
      var qText = entry.quotations[q].text.toLowerCase();
      if (qText.indexOf(val) !== -1) {
        count++;
        html += '<div style="margin:8px 0; padding:6px 10px; border-left:3px solid #888;">';
        html += '<div style="font-style:italic;">&ldquo;' + esc(entry.quotations[q].text) + '&rdquo;';
        if (entry.quotations[q].page && entry.quotations[q].page.trim() !== "") {
          html += ' <span style="font-style:normal; color:#666;">(p. ' + esc(entry.quotations[q].page) + ')</span>';
        }
        html += '</div>';
        html += '<div style="font-size:0.85em; margin-top:3px;">&mdash; <a onclick="showEntryFromHome(\'' + entry.id + '\')" style="cursor:pointer;">' + esc(entry.citation) + '</a></div>';
        html += '</div>';
      }
    }
  }
  if (count === 0) {
    resultsDiv.innerHTML = '<div style="color:#888; margin:6px 0;">No matching quotations found.</div>';
  } else {
    resultsDiv.innerHTML = '<div style="margin-top:6px;"><b>' + count + ' quotation' + (count === 1 ? '' : 's') + ' found:</b></div>' + html;
  }
}

function showEntriesWithoutSummaries() {
  var resultsDiv = document.getElementById("no-summary-results");
  if (resultsDiv.innerHTML !== "") {
    resultsDiv.innerHTML = "";
    return;
  }
  var sorted = entries.slice().sort(function(a, b) { return a.citation.localeCompare(b.citation); });
  var html = "";
  var count = 0;
  for (var i = 0; i < sorted.length; i++) {
    if (!sorted[i].longSummary || sorted[i].longSummary.trim() === "") {
      count++;
      html += '<div class="entry" style="margin:4px 0;">';
      html += '<a onclick="showEntryFromHome(\'' + sorted[i].id + '\')">' + esc(sorted[i].citation) + '</a>';
      html += '</div>';
    }
  }
  if (count === 0) {
    resultsDiv.innerHTML = '<div style="color:#888; margin:6px 0;">All entries have long summaries.</div>';
  } else {
    resultsDiv.innerHTML = '<div style="margin-top:6px;"><b>' + count + ' entr' + (count === 1 ? 'y' : 'ies') + ' without summaries:</b></div>' + html;
  }
}

function showDuplicates() {
  var resultsDiv = document.getElementById("duplicate-results");
  if (resultsDiv.innerHTML !== "") {
    resultsDiv.innerHTML = "";
    return;
  }
  // Normalize citation for comparison: lowercase, strip punctuation/whitespace
  function normalize(str) {
    return (str || "").toLowerCase().replace(/[^a-z0-9]/g, "");
  }
  // Group entries by normalized citation
  var groups = {};
  for (var i = 0; i < entries.length; i++) {
    var key = normalize(entries[i].citation);
    if (!groups[key]) groups[key] = [];
    groups[key].push(entries[i]);
  }
  // Also check for near-duplicates: same author last name + year + first 30 chars of normalized title
  function nearKey(citation) {
    var c = citation || "";
    var authorMatch = c.match(/^(.+?)\s*[\(,]/);
    var yearMatch = c.match(/\((\d{4})\)/);
    var titleMatch = c.match(/\(\d{4}\)\.\s*(.+?)(?:\.\s|$)/);
    var author = authorMatch ? normalize(authorMatch[1]) : "";
    var year = yearMatch ? yearMatch[1] : "";
    var title = titleMatch ? normalize(titleMatch[1]).substring(0, 30) : "";
    return author + "|" + year + "|" + title;
  }
  var nearGroups = {};
  for (var i = 0; i < entries.length; i++) {
    var nk = nearKey(entries[i].citation);
    if (!nearGroups[nk]) nearGroups[nk] = [];
    nearGroups[nk].push(entries[i]);
  }
  // Merge: collect all groups with 2+ entries, dedup by entry IDs
  var seen = {};
  var dupSets = [];
  // Exact matches first
  for (var key in groups) {
    if (groups[key].length >= 2) {
      var ids = groups[key].map(function(e) { return e.id; }).sort().join(",");
      if (!seen[ids]) {
        seen[ids] = true;
        dupSets.push(groups[key]);
      }
    }
  }
  // Near matches
  for (var nk in nearGroups) {
    if (nearGroups[nk].length >= 2) {
      var ids = nearGroups[nk].map(function(e) { return e.id; }).sort().join(",");
      if (!seen[ids]) {
        seen[ids] = true;
        dupSets.push(nearGroups[nk]);
      }
    }
  }
  // Filter out dismissed duplicates
  var filteredSets = [];
  for (var s = 0; s < dupSets.length; s++) {
    var ids = dupSets[s].map(function(e) { return e.id; }).sort().join(",");
    if (!dismissedDuplicates || dismissedDuplicates.indexOf(ids) === -1) {
      filteredSets.push(dupSets[s]);
    }
  }
  dupSets = filteredSets;
  if (dupSets.length === 0) {
    resultsDiv.innerHTML = '<div style="color:#888; margin:6px 0;">No duplicate entries found.</div>';
    return;
  }
  var html = '<div style="margin-top:6px;"><b>' + dupSets.length + ' group' + (dupSets.length === 1 ? '' : 's') + ' of potential duplicates:</b></div>';
  for (var g = 0; g < dupSets.length; g++) {
    html += '<div style="margin:8px 0; padding:6px 10px; border-left:3px solid #cc8800;">';
    for (var e = 0; e < dupSets[g].length; e++) {
      html += '<div style="margin:3px 0;"><a onclick="showEntryFromHome(\'' + dupSets[g][e].id + '\')" style="cursor:pointer;">' + esc(dupSets[g][e].citation) + '</a></div>';
    }
    html += '</div>';
  }
  resultsDiv.innerHTML = html;
  window._currentDupSets = dupSets;
}

function resetDuplicatesList() {
  var resultsDiv = document.getElementById("duplicate-results");
  resultsDiv.innerHTML = '<div class="edit-section">Are you sure you want to reset this list? <button onclick="doResetDuplicatesList()">Yes, reset</button> <button onclick="document.getElementById(\'duplicate-results\').innerHTML=\'\'">Cancel</button></div>';
}

function doResetDuplicatesList() {
  // Get current duplicate sets by running the same detection logic
  function normalize(str) {
    return (str || "").toLowerCase().replace(/[^a-z0-9]/g, "");
  }
  function nearKey(citation) {
    var c = citation || "";
    var authorMatch = c.match(/^(.+?)\s*[\(,]/);
    var yearMatch = c.match(/\((\d{4})\)/);
    var titleMatch = c.match(/\(\d{4}\)\.\s*(.+?)(?:\.\s|$)/);
    var author = authorMatch ? normalize(authorMatch[1]) : "";
    var year = yearMatch ? yearMatch[1] : "";
    var title = titleMatch ? normalize(titleMatch[1]).substring(0, 30) : "";
    return author + "|" + year + "|" + title;
  }
  var groups = {};
  for (var i = 0; i < entries.length; i++) {
    var key = normalize(entries[i].citation);
    if (!groups[key]) groups[key] = [];
    groups[key].push(entries[i]);
  }
  var nearGroups = {};
  for (var i = 0; i < entries.length; i++) {
    var nk = nearKey(entries[i].citation);
    if (!nearGroups[nk]) nearGroups[nk] = [];
    nearGroups[nk].push(entries[i]);
  }
  var seen = {};
  var count = 0;
  for (var key in groups) {
    if (groups[key].length >= 2) {
      var ids = groups[key].map(function(e) { return e.id; }).sort().join(",");
      if (!seen[ids]) {
        seen[ids] = true;
        if (!dismissedDuplicates) dismissedDuplicates = [];
        if (dismissedDuplicates.indexOf(ids) === -1) {
          dismissedDuplicates.push(ids);
          count++;
        }
      }
    }
  }
  for (var nk in nearGroups) {
    if (nearGroups[nk].length >= 2) {
      var ids = nearGroups[nk].map(function(e) { return e.id; }).sort().join(",");
      if (!seen[ids]) {
        seen[ids] = true;
        if (dismissedDuplicates.indexOf(ids) === -1) {
          dismissedDuplicates.push(ids);
          count++;
        }
      }
    }
  }
  autoSave();
  var resultsDiv = document.getElementById("duplicate-results");
  if (resultsDiv) resultsDiv.innerHTML = "";
  alert("Dismissed " + count + " duplicate group" + (count === 1 ? "" : "s") + ". They won\u2019t appear in future duplicate checks.");
}

// Feature 4: current sort mode for home view
var currentSort = "alpha";

function showHome() {
  navHistory = [];
  clearActive();
  document.querySelector('#sidebar a').className = "active";
  var content = document.getElementById("content");
  content.innerHTML = "";

  // Feature 4: sort entries based on current mode
  var sorted = entries.slice();
  if (currentSort === "year-new") {
    sorted.sort(function(a, b) { return extractYear(b.citation) - extractYear(a.citation); });
  } else if (currentSort === "year-old") {
    sorted.sort(function(a, b) { return extractYear(a.citation) - extractYear(b.citation); });
  } else if (currentSort === "recent") {
    sorted.sort(function(a, b) {
      var da = a.dateModified || a.dateAdded || "";
      var db = b.dateModified || b.dateAdded || "";
      return db.localeCompare(da);
    });
  } else {
    sorted.sort(function(a, b) { return a.citation.localeCompare(b.citation); });
  }

  // Build letter headings (only in alpha sort) and entry elements
  var letterHeadings = {};
  var lastLetter = "";
  var entryElements = [];
  for (var i = 0; i < sorted.length; i++) {
    var firstChar = sorted[i].citation.replace(/[^a-zA-Z]/g, "").charAt(0).toUpperCase();
    if (currentSort === "alpha" && firstChar !== lastLetter) {
      var heading = document.createElement("div");
      heading.className = "letter-heading";
      heading.style.fontWeight = "bold";
      heading.style.fontSize = "1.2em";
      heading.style.marginTop = "16px";
      heading.style.marginBottom = "6px";
      heading.textContent = firstChar;
      letterHeadings[firstChar] = heading;
      entryElements.push(heading);
      lastLetter = firstChar;
    }
    var div = document.createElement("div");
    div.className = "entry entry-item";
    // Feature 2: store full text for search across all fields
    div.setAttribute("data-citation", sorted[i].citation);
    div.setAttribute("data-fulltext", sorted[i].citation + " " + sorted[i].shortSummary + " " + sorted[i].longSummary);
    var summarySearchText = (sorted[i].shortSummary || "") + " " + (sorted[i].longSummary || "");
    var quotationText = "";
    if (sorted[i].quotations) {
      for (var q = 0; q < sorted[i].quotations.length; q++) {
        quotationText += " " + (sorted[i].quotations[q].text || "");
      }
    }
    summarySearchText += quotationText;
    if (!readOnly) summarySearchText += " " + (sorted[i].editorialNotes || "");
    div.setAttribute("data-summarytext", summarySearchText);
    div.setAttribute("data-quotations", quotationText);
    div.setAttribute("data-keywords", (sorted[i].keywords || []).join(", ").toLowerCase());
    div.setAttribute("data-year", extractYear(sorted[i].citation));
    var a = document.createElement("a");
    a.textContent = sorted[i].citation;
    (function(id) { a.onclick = function() { showEntryFromHome(id); }; })(sorted[i].id);
    div.appendChild(a);
    entryElements.push(div);
  }

  // A-Z jump bar (only in alpha sort mode)
  if (currentSort === "alpha") {
    var jumpBar = document.createElement("div");
    jumpBar.style.marginBottom = "8px";
    for (var c = 65; c <= 90; c++) {
      var letter = String.fromCharCode(c);
      var la = document.createElement("a");
      la.textContent = letter;
      la.style.marginRight = "6px";
      (function(targetEl) {
        la.onclick = function(e) {
          e.preventDefault();
          if (targetEl) {
            targetEl.scrollIntoView(true);
          }
        };
      })(letterHeadings[letter]);
      jumpBar.appendChild(la);
    }
    content.appendChild(jumpBar);
  }

  // Feature 4: Sort dropdown
  var sortBar = document.createElement("div");
  sortBar.className = "sort-bar";
  sortBar.innerHTML = 'Sort: <select id="sort-select" onchange="changeSort(this.value)">' +
    '<option value="alpha"' + (currentSort === "alpha" ? " selected" : "") + '>Author (A\u2013Z)</option>' +
    '<option value="year-new"' + (currentSort === "year-new" ? " selected" : "") + '>Year (newest first)</option>' +
    '<option value="year-old"' + (currentSort === "year-old" ? " selected" : "") + '>Year (oldest first)</option>' +
    '<option value="recent"' + (currentSort === "recent" ? " selected" : "") + '>Recently modified</option>' +
    '</select>';
  content.appendChild(sortBar);

  // Date range filter
  var dateBar = document.createElement("div");
  dateBar.className = "search-bar";
  dateBar.innerHTML = 'Year range: <input type="number" id="year-from" oninput="filterEntries()" placeholder="From" style="width:70px;font-family:serif;font-size:inherit;"> \u2013 <input type="number" id="year-to" oninput="filterEntries()" placeholder="To" style="width:70px;font-family:serif;font-size:inherit;"> <a onclick="clearYearRange()" style="cursor:pointer;font-size:0.9em;margin-left:6px;">clear</a>';
  content.appendChild(dateBar);

  // Search bars (Feature 2: "Any term" now searches summaries too)
  var sb1 = document.createElement("div");
  sb1.className = "search-bar";
  sb1.innerHTML = 'Lead author\u2019s last name: <input type="text" id="search-author" oninput="filterEntries()" placeholder="Filter by last name...">';
  content.appendChild(sb1);
  var sb2 = document.createElement("div");
  sb2.className = "search-bar";
  sb2.innerHTML = 'Any term in bibliographic information: <input type="text" id="search-term" oninput="filterEntries()" placeholder="Search citations...">';
  content.appendChild(sb2);

  var sb2b = document.createElement("div");
  sb2b.className = "search-bar";
  if (readOnly) {
    sb2b.innerHTML = 'Search summaries and quotations: <input type="text" id="search-summaries" oninput="filterEntries()" placeholder="Search summaries, quotations...">';
  } else {
    sb2b.innerHTML = 'Search summaries, quotations, and notes: <input type="text" id="search-summaries" oninput="filterEntries()" placeholder="Search summaries, quotations, and editorial notes...">';
  }
  content.appendChild(sb2b);

  // Key Quotations search bar
  var sb3 = document.createElement("div");
  sb3.className = "search-bar";
  sb3.innerHTML = 'Search just key quotations: <input type="text" id="search-quotations" oninput="searchQuotations()" placeholder="Search all saved quotations...">';
  content.appendChild(sb3);

  var sb2c = document.createElement("div");
  sb2c.className = "search-bar";
  sb2c.innerHTML = 'Search keywords: <input type="text" id="search-keywords" oninput="filterEntries()" placeholder="Filter by keyword...">';
  content.appendChild(sb2c);

  var kwBtn = document.createElement("div");
  kwBtn.style.marginTop = "6px";
  kwBtn.innerHTML = '<button onclick="showKeywordBrowser()">Browse keywords</button>' + (!readOnly ? ' <button onclick="showBulkKeywordEdit()">Bulk edit keywords</button>' : '');
  content.appendChild(kwBtn);
  var kwResults = document.createElement("div");
  kwResults.id = "keyword-browse-results";
  content.appendChild(kwResults);
  var bulkKwArea = document.createElement("div");
  bulkKwArea.id = "bulk-keyword-area";
  content.appendChild(bulkKwArea);

  var qResults = document.createElement("div");
  qResults.id = "quotation-search-results";
  content.appendChild(qResults);

  var noSumBtn = document.createElement("div");
  noSumBtn.style.marginTop = "6px";
  noSumBtn.innerHTML = '<button onclick="showEntriesWithoutSummaries()">Entries without summaries</button>';
  content.appendChild(noSumBtn);
  var noSumResults = document.createElement("div");
  noSumResults.id = "no-summary-results";
  content.appendChild(noSumResults);

  if (!readOnly) {
    var addBtnRow = document.createElement("div");
    addBtnRow.style.marginTop = "6px";
    addBtnRow.innerHTML = '<button onclick="showAddEntryForm()">Add entry</button> <button onclick="showBulkAddForm()">Bulk add entries</button>';
    content.appendChild(addBtnRow);
    var addFormArea = document.createElement("div");
    addFormArea.id = "add-entry-form-area";
    content.appendChild(addFormArea);
  }

  if (!readOnly) {
    var dupBtn = document.createElement("div");
    dupBtn.style.marginTop = "6px";
    dupBtn.innerHTML = '<button onclick="showDuplicates()">Duplicates</button> <button onclick="resetDuplicatesList()">Reset duplicates list</button>';
    content.appendChild(dupBtn);
    var dupResults = document.createElement("div");
    dupResults.id = "duplicate-results";
    content.appendChild(dupResults);
  }

  content.appendChild(document.createElement("br"));

  // Append all entry elements
  for (var j = 0; j < entryElements.length; j++) {
    content.appendChild(entryElements[j]);
  }

  // Bottom spacer for A-Z scroll
  var spacer = document.createElement("div");
  spacer.className = "bottom-spacer";
  spacer.style.height = "80vh";
  content.appendChild(spacer);

  // Edit button (editor only)
  if (!readOnly) {
    content.appendChild(document.createElement("br"));
    var editBtn = document.createElement("button");
    editBtn.textContent = "Edit";
    editBtn.onclick = function() { editHome(); };
    content.appendChild(editBtn);
    var editArea = document.createElement("div");
    editArea.id = "home-edit-area";
    content.appendChild(editArea);
  }

  content.scrollTop = 0;
}

function changeSort(val) {
  currentSort = val;
  showHome();
}

// Feature 3: Uncategorized entries view
function showUncategorized() {
  navHistory = [];
  clearActive();
  var links = document.querySelectorAll("#sidebar a");
  if (links.length >= 3) links[2].className = "active";
  var content = document.getElementById("content");
  var html = "<div><b>Uncategorized Entries</b></div><br>";
  var found = false;
  for (var i = 0; i < entries.length; i++) {
    if (entries[i].topics.length === 0) {
      found = true;
      html += '<div class="entry">';
      html += '<a onclick="showEntryFromUncategorized(\'' + entries[i].id + '\')">' + esc(entries[i].citation) + '</a>';
      html += '</div>';
    }
  }
  if (!found) {
    html += '<div style="color:#666;">All entries are assigned to at least one topic.</div>';
  }
  content.innerHTML = html;
  content.scrollTop = 0;
}

function showEntryFromUncategorized(entryId) {
  pushNav(function() { showUncategorized(); });
  showEntry(entryId);
}

// Feature 7: Recently added/modified view
function showRecentlyAdded() {
  navHistory = [];
  clearActive();
  var links = document.querySelectorAll("#sidebar a");
  if (links.length >= 2) links[1].className = "active";
  var content = document.getElementById("content");
  var html = "<div><b>Recently Added / Modified</b></div><br>";

  var sorted = entries.slice().sort(function(a, b) {
    var da = a.dateModified || a.dateAdded || "";
    var db = b.dateModified || b.dateAdded || "";
    return db.localeCompare(da);
  });

  var limit = Math.min(sorted.length, 50);
  for (var i = 0; i < limit; i++) {
    html += '<div class="entry">';
    html += '<a onclick="showEntryFromRecent(\'' + sorted[i].id + '\')">' + esc(sorted[i].citation) + '</a>';
    html += '<span class="date-badge">' + formatDate(sorted[i].dateModified || sorted[i].dateAdded) + '</span>';
    html += '</div>';
  }
  if (entries.length === 0) {
    html += '<div style="color:#666;">No entries yet.</div>';
  }
  content.innerHTML = html;
  content.scrollTop = 0;
}

function showEntryFromRecent(entryId) {
  pushNav(function() { showRecentlyAdded(); });
  showEntry(entryId);
}

function editHome() {
  var html = '<div class="edit-section">';
  html += '<label><b>Add a single entry:</b></label>';
  html += '<label>Citation:</label>';
  html += '<textarea id="new-citation" rows="2" placeholder="Author, A. (2020). Title. Publisher."></textarea>';
  html += '<label>Short summary:</label>';
  html += '<textarea id="new-short" rows="2"></textarea>';
  html += '<label>Long summary:</label>';
  html += '<textarea id="new-long" rows="4"></textarea>';
  html += '<label>URL / DOI (optional):</label>';
  html += '<input type="text" id="new-url" style="width:100%;" placeholder="https://doi.org/...">';
  html += '<br><button onclick="saveNewEntry()">Add Entry</button>';
  html += '</div>';
  html += '<div class="edit-section">';
  html += '<label><b>Bulk add entries</b> (one citation per line):</label>';
  html += '<textarea id="bulk-citations" rows="6" placeholder="Author, A. (2020). Title one. Publisher.\nAuthor, B. (2021). Title two. Publisher."></textarea>';
  html += '<br><button onclick="bulkAddEntries()">Add All</button>';
  html += '</div>';
  document.getElementById("home-edit-area").innerHTML = html;
}

function showAddEntryForm() {
  var area = document.getElementById("add-entry-form-area");
  if (area.innerHTML !== "") { area.innerHTML = ""; return; }
  var html = '<div class="edit-section" style="margin-top:8px;">';
  html += '<label>Citation (required):</label>';
  html += '<textarea id="add-full-citation" rows="3" placeholder="Author, A. (2020). Title. Publisher."></textarea>';
  html += '<label>One Sentence Summary:</label>';
  html += '<input type="text" id="add-full-short" placeholder="Brief one-sentence summary...">';
  html += '<label>Longer Summary:</label>';
  html += '<textarea id="add-full-long" rows="5" placeholder="Detailed summary..."></textarea>';
  html += '<label>URL (link to PDF):</label>';
  html += '<input type="text" id="add-full-url" placeholder="https://...">';
  html += '<label>Keywords (comma-separated):</label>';
  html += '<input type="text" id="add-full-keywords" placeholder="e.g. color perception, empirical, Berlin & Kay">';
  html += '<label>Topics:</label>';
  html += '<div style="max-height:200px; overflow-y:auto; border:1px solid #ccc; padding:6px;">';
  for (var t = 0; t < topics.length; t++) {
    html += '<div><input type="checkbox" class="add-full-topic" value="' + escAttr(topics[t].id) + '"> ' + esc(topics[t].name) + '</div>';
  }
  html += '</div>';
  html += '<br><button onclick="saveAddEntryForm()">Save</button> ';
  html += '<button onclick="document.getElementById(\'add-entry-form-area\').innerHTML=\'\'">Cancel</button>';
  html += '</div>';
  area.innerHTML = html;
}

function saveAddEntryForm() {
  var citation = document.getElementById("add-full-citation").value.trim();
  if (citation === "") { alert("Citation is required."); return; }
  snapshot();
  var now = new Date().toISOString();
  var kwRaw = document.getElementById("add-full-keywords").value;
  var kwArr = [];
  var kwParts = kwRaw.split(",");
  for (var k = 0; k < kwParts.length; k++) {
    var kw = kwParts[k].trim();
    if (kw !== "") kwArr.push(kw);
  }
  var selectedTopics = [];
  var topicCbs = document.querySelectorAll(".add-full-topic");
  for (var t = 0; t < topicCbs.length; t++) {
    if (topicCbs[t].checked) selectedTopics.push(topicCbs[t].value);
  }
  entries.push({
    id: "entry_" + Date.now(),
    citation: citation,
    shortSummary: document.getElementById("add-full-short").value,
    longSummary: document.getElementById("add-full-long").value,
    url: document.getElementById("add-full-url").value.trim(),
    dateAdded: now,
    dateModified: now,
    topics: selectedTopics,
    quotations: [],
    summaryHistory: [],
    seeAlso: [],
    keywords: kwArr,
    editorialNotes: ""
  });
  entries.sort(function(a, b) { return a.citation.localeCompare(b.citation); });
  autoSave();
  renderSidebar();
  showHome();
  alert("Entry added successfully.");
}

function showBulkAddForm() {
  var area = document.getElementById("add-entry-form-area");
  if (area.innerHTML !== "") { area.innerHTML = ""; return; }
  var html = '<div class="edit-section" style="margin-top:8px;">';
  html += '<label>Paste citations, one per line:</label>';
  html += '<textarea id="bulk-add-citations" rows="10" placeholder="Author, A. (2020). Title one. Publisher.\nAuthor, B. (2021). Title two. Publisher."></textarea>';
  html += '<br><button onclick="saveBulkAddForm()">Add All</button> ';
  html += '<button onclick="document.getElementById(\'add-entry-form-area\').innerHTML=\'\'">Cancel</button>';
  html += '</div>';
  area.innerHTML = html;
}

function saveBulkAddForm() {
  var text = document.getElementById("bulk-add-citations").value;
  var lines = text.split("\n");
  var count = 0;
  snapshot();
  var now = new Date().toISOString();
  for (var i = 0; i < lines.length; i++) {
    var line = lines[i].trim();
    if (line === "") continue;
    entries.push({
      id: "entry_" + Date.now() + "_" + i,
      citation: line,
      shortSummary: "",
      longSummary: "",
      url: "",
      dateAdded: now,
      dateModified: now,
      topics: [],
      quotations: [],
      summaryHistory: [],
      seeAlso: [],
      keywords: []
    });
    count++;
  }
  if (count > 0) {
    entries.sort(function(a, b) { return a.citation.localeCompare(b.citation); });
  }
  autoSave();
  renderSidebar();
  showHome();
}

function saveNewEntry() {
  var citation = document.getElementById("new-citation").value.trim();
  if (citation === "") return;
  snapshot();
  var now = new Date().toISOString();
  entries.push({
    id: "entry_" + Date.now(),
    citation: citation,
    shortSummary: document.getElementById("new-short").value,
    longSummary: document.getElementById("new-long").value,
    url: document.getElementById("new-url").value.trim(),
    dateAdded: now,
    dateModified: now,
    topics: [],
    quotations: [],
    summaryHistory: [], seeAlso: [], keywords: [], editorialNotes: ""
  });
  entries.sort(function(a, b) { return a.citation.localeCompare(b.citation); });
  autoSave();
  renderSidebar();
  showHome();
}

function bulkAddEntries() {
  snapshot();
  var text = document.getElementById("bulk-citations").value;
  var lines = text.split("\n");
  var count = 0;
  var now = new Date().toISOString();
  for (var i = 0; i < lines.length; i++) {
    var line = lines[i].trim();
    if (line === "") continue;
    entries.push({
      id: "entry_" + Date.now() + "_" + i,
      citation: line,
      shortSummary: "",
      longSummary: "",
      url: "",
      dateAdded: now,
      dateModified: now,
      topics: [],
      quotations: [],
      summaryHistory: [], seeAlso: [], keywords: [], editorialNotes: ""
    });
    count++;
  }
  if (count > 0) {
    entries.sort(function(a, b) { return a.citation.localeCompare(b.citation); });
  }
  autoSave();
  renderSidebar();
  showHome();
}

function showTopic(topicId, keepNav) {
  if (!keepNav) navHistory = [];
  clearActive();
  var link = document.querySelector('#sidebar a[data-topic="' + topicId + '"]');
  if (link) link.className = "active";
  var topicName = "";
  for (var i = 0; i < topics.length; i++) {
    if (topics[i].id === topicId) { topicName = topics[i].name; break; }
  }
  // Gather and sort topic entries
  var topicEntries = [];
  for (var i = 0; i < entries.length; i++) {
    if (entries[i].topics.indexOf(topicId) !== -1) {
      topicEntries.push(entries[i]);
    }
  }
  topicEntries.sort(function(a, b) { return a.citation.localeCompare(b.citation); });

  var html = "";
  if (navHistory.length > 0) {
    html += '<a onclick="goBack()">&larr; Back</a><br><br>';
  }
  html += "<div><b>" + esc(topicName) + "</b> <span style=\"font-weight:normal;\">(" + topicEntries.length + " entr" + (topicEntries.length === 1 ? "y" : "ies") + ")</span></div>";

  // Search bars
  html += '<div class="search-bar" style="margin-top:8px;">Any term in bibliographic information: <input type="text" id="topic-search-citation" oninput="filterTopicEntries()" placeholder="Search citations..."></div>';
  if (readOnly) {
    html += '<div class="search-bar">Search summaries on this topic: <input type="text" id="topic-search-full" oninput="filterTopicEntries()" placeholder="Search summaries..."></div>';
  } else {
    html += '<div class="search-bar">Search summaries and notes on this topic: <input type="text" id="topic-search-full" oninput="filterTopicEntries()" placeholder="Search summaries, quotations, and notes..."></div>';
  }

  // A-Z jump bar
  var letters = {};
  for (var i = 0; i < topicEntries.length; i++) {
    var fc = topicEntries[i].citation.replace(/[^a-zA-Z]/g, "").charAt(0).toUpperCase();
    if (fc) letters[fc] = true;
  }
  if (topicEntries.length > 10) {
    html += '<div style="margin-bottom:8px;">';
    for (var c = 65; c <= 90; c++) {
      var letter = String.fromCharCode(c);
      if (letters[letter]) {
        html += '<a onclick="jumpToTopicLetter(\'' + letter + '\')" style="margin-right:6px; cursor:pointer;">' + letter + '</a>';
      } else {
        html += '<span style="margin-right:6px; color:#ccc;">' + letter + '</span>';
      }
    }
    html += '</div>';
  }

  html += '<br>';
  // Entry list with letter headings
  var lastLetter = "";
  for (var i = 0; i < topicEntries.length; i++) {
    var firstChar = topicEntries[i].citation.replace(/[^a-zA-Z]/g, "").charAt(0).toUpperCase();
    if (firstChar !== lastLetter) {
      html += '<div class="topic-letter-heading" data-letter="' + firstChar + '" style="font-weight:bold; font-size:1.1em; margin-top:12px; margin-bottom:4px;">' + firstChar + '</div>';
      lastLetter = firstChar;
    }
    // Build full-text search content
    var fulltext = (topicEntries[i].shortSummary || '') + ' ' + (topicEntries[i].longSummary || '');
    if (topicEntries[i].quotations) {
      for (var q = 0; q < topicEntries[i].quotations.length; q++) {
        fulltext += ' ' + (topicEntries[i].quotations[q].text || '');
      }
    }
    if (!readOnly) fulltext += ' ' + (topicEntries[i].editorialNotes || '');
    html += '<div class="entry topic-entry-item" data-citation="' + escAttr(topicEntries[i].citation) + '" data-fulltext="' + escAttr(fulltext) + '">';
    html += '<a onclick="showEntryFromTopic(\'' + topicEntries[i].id + '\', \'' + topicId + '\')">' + esc(topicEntries[i].citation) + '</a>';
    html += '<div class="short-summary">' + esc(topicEntries[i].shortSummary) + '</div>';
    html += '</div>';
  }
  if (!readOnly) {
    html += '<br><button onclick="editTopic(\'' + topicId + '\')">Edit entries in this topic</button> ';
    html += '<button onclick="bulkAddToTopic(\'' + topicId + '\')">Bulk add entries</button> ';
  }
  html += '<button onclick="exportTopicPDF(\'' + topicId + '\')">Export topical bibliography as PDF</button>';
  if (!readOnly) {
    html += '<div id="topic-edit-area"></div>';
  }
  document.getElementById("content").innerHTML = html;
  document.getElementById("content").scrollTop = 0;
}

function filterTopicEntries() {
  var citVal = document.getElementById("topic-search-citation").value.toLowerCase().trim();
  var fullVal = document.getElementById("topic-search-full").value.toLowerCase().trim();
  var isFiltering = citVal !== "" || fullVal !== "";
  var items = document.querySelectorAll(".topic-entry-item");
  var headings = document.querySelectorAll(".topic-letter-heading");
  for (var h = 0; h < headings.length; h++) {
    headings[h].style.display = isFiltering ? "none" : "";
  }
  for (var i = 0; i < items.length; i++) {
    var citation = (items[i].getAttribute("data-citation") || "").toLowerCase();
    var fulltext = (items[i].getAttribute("data-fulltext") || "").toLowerCase();
    var citMatch = citVal === "" || citation.indexOf(citVal) !== -1;
    var fullMatch = fullVal === "" || fulltext.indexOf(fullVal) !== -1;
    items[i].style.display = (citMatch && fullMatch) ? "" : "none";
  }
}

function jumpToTopicLetter(letter) {
  var heading = document.querySelector('.topic-letter-heading[data-letter="' + letter + '"]');
  if (heading) heading.scrollIntoView(true);
}

function bulkRemoveFromTopic(topicId) {
  var topicName = "";
  for (var i = 0; i < topics.length; i++) {
    if (topics[i].id === topicId) { topicName = topics[i].name; break; }
  }
  var topicEntries = [];
  for (var i = 0; i < entries.length; i++) {
    if (entries[i].topics.indexOf(topicId) !== -1) topicEntries.push(entries[i]);
  }
  topicEntries.sort(function(a, b) { return a.citation.localeCompare(b.citation); });
  var html = '<div class="edit-section">';
  html += '<label>Select entries to remove from ' + esc(topicName) + ':</label><br><br>';
  for (var i = 0; i < topicEntries.length; i++) {
    html += '<div style="margin-bottom:6px"><input type="checkbox" class="remove-topic-check" value="' + escAttr(topicEntries[i].id) + '"> ' + esc(topicEntries[i].citation) + '</div>';
  }
  html += '<br><button onclick="doRemoveFromTopic(\'' + topicId + '\')">Remove Selected</button> ';
  html += '<button onclick="showTopic(\'' + topicId + '\')">Cancel</button>';
  html += '</div>';
  document.getElementById("topic-edit-area").innerHTML = html;
}

function doRemoveFromTopic(topicId) {
  snapshot();
  var checks = document.querySelectorAll(".remove-topic-check");
  for (var c = 0; c < checks.length; c++) {
    if (!checks[c].checked) continue;
    var entryId = checks[c].value;
    for (var e = 0; e < entries.length; e++) {
      if (entries[e].id === entryId) {
        var idx = entries[e].topics.indexOf(topicId);
        if (idx !== -1) entries[e].topics.splice(idx, 1);
        break;
      }
    }
  }
  autoSave();
  renderSidebar();
  showTopic(topicId);
}

function editTopic(topicId) {
  var topicName = "";
  for (var i = 0; i < topics.length; i++) {
    if (topics[i].id === topicId) { topicName = topics[i].name; break; }
  }
  var html = '<div class="edit-section">';
  html += "<label>Select entries for " + esc(topicName) + ":</label><br><br>";
  for (var i = 0; i < entries.length; i++) {
    var checked = entries[i].topics.indexOf(topicId) !== -1 ? " checked" : "";
    html += '<div style="margin-bottom:6px"><input type="checkbox" id="tc_' + entries[i].id + '"' + checked + '> ' + esc(entries[i].citation) + '</div>';
  }
  html += '<br><button onclick="saveTopic(\'' + topicId + '\')">Save</button> ';
  html += '<button onclick="showTopic(\'' + topicId + '\')">Cancel</button>';
  html += '</div>';
  document.getElementById("topic-edit-area").innerHTML = html;
}

function saveTopic(topicId) {
  snapshot();
  for (var i = 0; i < entries.length; i++) {
    var cb = document.getElementById("tc_" + entries[i].id);
    var idx = entries[i].topics.indexOf(topicId);
    if (cb.checked && idx === -1) {
      entries[i].topics.push(topicId);
    } else if (!cb.checked && idx !== -1) {
      entries[i].topics.splice(idx, 1);
    }
  }
  autoSave();
  renderSidebar();
  showTopic(topicId);
}

function bulkAddToTopic(topicId) {
  var topicName = "";
  for (var i = 0; i < topics.length; i++) {
    if (topics[i].id === topicId) { topicName = topics[i].name; break; }
  }
  var html = '<div class="edit-section">';
  html += '<label>Add multiple entries to ' + esc(topicName) + ':</label>';
  html += '<label>Paste citations, one per line:</label>';
  html += '<textarea id="bulk-topic-citations" rows="10" placeholder="Author, A. (2020). Title one. Publisher.\nAuthor, B. (2021). Title two. Publisher."></textarea>';
  html += '<br><button onclick="saveBulkToTopic(\'' + topicId + '\')">Add All</button> ';
  html += '<button onclick="showTopic(\'' + topicId + '\')">Cancel</button>';
  html += '</div>';
  document.getElementById("topic-edit-area").innerHTML = html;
}

function saveBulkToTopic(topicId) {
  snapshot();
  var text = document.getElementById("bulk-topic-citations").value;
  var parts = text.split("\n");
  var count = 0;
  var now = new Date().toISOString();
  for (var i = 0; i < parts.length; i++) {
    var citation = parts[i].trim();
    if (citation === "") continue;
    entries.push({
      id: "entry_" + Date.now() + "_" + i,
      citation: citation,
      shortSummary: "",
      longSummary: "",
      url: "",
      dateAdded: now,
      dateModified: now,
      topics: [topicId],
      quotations: [],
      summaryHistory: [], seeAlso: [], keywords: [], editorialNotes: ""
    });
    count++;
  }
  if (count > 0) {
    entries.sort(function(a, b) { return a.citation.localeCompare(b.citation); });
    autoSave();
    renderSidebar();
  }
  showTopic(topicId);
}

function showEntryFromHome(entryId) {
  pushNav(function() { showHome(); });
  showEntry(entryId);
}

function showEntryFromTopic(entryId, topicId) {
  pushNav(function() { showTopic(topicId, true); });
  showEntry(entryId);
}

function showEntryFromEntry(entryId, fromEntryId) {
  pushNav(function() { showEntry(fromEntryId); });
  showEntry(entryId);
}

function showTopicFromEntry(topicId, entryId) {
  pushNav(function() { showEntry(entryId); });
  showTopic(topicId, true);
}

function showKeywordEntries(keyword, fromEntryId) {
  if (fromEntryId) {
    pushNav(function() { showEntry(fromEntryId); });
  }
  clearActive();
  var matchEntries = [];
  for (var i = 0; i < entries.length; i++) {
    if (entries[i].keywords) {
      for (var k = 0; k < entries[i].keywords.length; k++) {
        if (entries[i].keywords[k] === keyword) {
          matchEntries.push(entries[i]);
          break;
        }
      }
    }
  }
  matchEntries.sort(function(a, b) { return a.citation.localeCompare(b.citation); });
  var html = "";
  if (navHistory.length > 0) {
    html += '<a onclick="goBack()">&larr; Back</a><br><br>';
  }
  html += '<div><b>Keyword: ' + esc(keyword) + '</b> <span style="font-weight:normal;">(' + matchEntries.length + ' entr' + (matchEntries.length === 1 ? 'y' : 'ies') + ')</span></div><br>';
  for (var i = 0; i < matchEntries.length; i++) {
    html += '<div class="entry">';
    html += '<a onclick="showEntryFromKeyword(\'' + escAttr(matchEntries[i].id) + '\', \'' + escAttr(keyword) + '\')">' + esc(matchEntries[i].citation) + '</a>';
    if (matchEntries[i].shortSummary) {
      html += '<div class="short-summary">' + esc(matchEntries[i].shortSummary) + '</div>';
    }
    html += '</div>';
  }
  document.getElementById("content").innerHTML = html;
  document.getElementById("content").scrollTop = 0;
}

function showEntryFromKeyword(entryId, keyword) {
  pushNav(function() { showKeywordEntries(keyword); });
  showEntry(entryId);
}

// Feature 5: URL/DOI displayed on entry page
function showEntry(entryId) {
  clearActive();
  var entry = null;
  for (var i = 0; i < entries.length; i++) {
    if (entries[i].id === entryId) { entry = entries[i]; break; }
  }
  if (!entry) return;
  var html = "";
  if (navHistory.length > 0) {
    html += '<a onclick="goBack()">&larr; Back</a><br><br>';
  }
  html += "<div>" + esc(entry.citation) + "</div>";
  if (entry.url && entry.url.trim() !== "") {
    html += '<div class="entry-url"><a href="' + escAttr(entry.url) + '" target="_blank">Link to PDF</a></div>';
  }
  // Topics display (above keywords)
  if (entry.topics && entry.topics.length > 0) {
    html += '<div style="margin-top:6px;">';
    for (var ti = 0; ti < entry.topics.length; ti++) {
      var tName = "";
      for (var tj = 0; tj < topics.length; tj++) {
        if (topics[tj].id === entry.topics[ti]) { tName = topics[tj].name; break; }
      }
      if (tName) {
        html += '<a onclick="showTopicFromEntry(\'' + escAttr(entry.topics[ti]) + '\', \'' + escAttr(entryId) + '\')" style="display:inline-block; background:rgba(0,0,0,0.07); padding:2px 8px; margin:2px 4px 2px 0; font-size:0.85em; border-radius:3px; cursor:pointer; text-decoration:none;">' + esc(tName) + '</a>';
      }
    }
    html += '</div>';
  }
  // Keywords display
  if (entry.keywords && entry.keywords.length > 0) {
    html += '<div style="margin-top:4px;">';
    for (var k = 0; k < entry.keywords.length; k++) {
      html += '<a onclick="showKeywordEntries(\'' + escAttr(entry.keywords[k]) + '\', \'' + escAttr(entryId) + '\')" style="display:inline-block; background:#e8e4d8; padding:2px 8px; margin:2px 4px 2px 0; font-size:0.85em; border-radius:3px; cursor:pointer; text-decoration:none; color:#000;">' + esc(entry.keywords[k]) + '</a>';
    }
    html += '</div>';
  }
  if (entry.shortSummary && entry.shortSummary.trim() !== "") {
    html += '<br><div><b>One Sentence Summary</b></div><div id="short-summary-display"><i>' + esc(entry.shortSummary) + '</i></div>';
  }
  html += '<br><div><b>Longer Summary</b></div><div id="long-summary-display">' + esc(entry.longSummary) + "</div>";

  // Key Quotations section
  html += '<br><div style="margin-top:10px;"><b>Key Quotations</b></div>';
  if (entry.quotations && entry.quotations.length > 0) {
    for (var q = 0; q < entry.quotations.length; q++) {
      html += '<div class="quotation-item" style="margin:8px 0 8px 16px; padding:6px 10px; border-left:3px solid #888; font-style:italic;">';
      html += '&ldquo;' + esc(entry.quotations[q].text) + '&rdquo;';
      if (entry.quotations[q].page && entry.quotations[q].page.trim() !== "") {
        html += ' <span style="font-style:normal; color:#666;">(p. ' + esc(entry.quotations[q].page) + ')</span>';
      }
      html += '</div>';
    }
  } else {
    html += '<div style="margin:6px 0 6px 16px; color:#888; font-size:0.9em;">No quotations saved yet.</div>';
  }
  html += '<div id="quotation-edit-area"></div>';

  // See Also section
  html += '<br><div style="margin-top:10px;"><b>See Also</b></div>';
  if (entry.seeAlso && entry.seeAlso.length > 0) {
    for (var s = 0; s < entry.seeAlso.length; s++) {
      var linked = null;
      for (var li = 0; li < entries.length; li++) {
        if (entries[li].id === entry.seeAlso[s]) { linked = entries[li]; break; }
      }
      if (linked) {
        html += '<div style="margin:4px 0 4px 16px;"><a onclick="showEntryFromEntry(\'' + linked.id + '\', \'' + entryId + '\')" style="cursor:pointer;">' + esc(linked.citation) + '</a></div>';
      }
    }
  } else {
    html += '<div style="margin:6px 0 6px 16px; color:#888; font-size:0.9em;">No cross-references added yet.</div>';
  }
  html += '<div id="seealso-edit-area"></div>';

  // Editorial Notes section (editor only)
  if (!readOnly) {
    html += '<br><div style="margin-top:10px;"><b>Editorial Notes</b></div>';
    if (entry.editorialNotes && entry.editorialNotes.trim() !== "") {
      html += '<div id="editorial-notes-display">' + esc(entry.editorialNotes) + '</div>';
    } else {
      html += '<div id="editorial-notes-display" style="color:#888; font-size:0.9em;">No editorial notes yet.</div>';
    }
  }

  // Summary History section (Feature 9)
  if (entry.summaryHistory && entry.summaryHistory.length > 0) {
    html += '<br><div style="margin-top:10px;"><a onclick="toggleSummaryHistory(\'' + entryId + '\')" style="font-size:0.9em; cursor:pointer;">View Summary History (' + entry.summaryHistory.length + ' previous version' + (entry.summaryHistory.length === 1 ? '' : 's') + ')</a></div>';
    html += '<div id="summary-history" style="display:none;">';
    for (var h = entry.summaryHistory.length - 1; h >= 0; h--) {
      var hist = entry.summaryHistory[h];
      html += '<div style="margin:10px 0; padding:8px; background:#f5f5f0; border:1px solid #ddd;">';
      html += '<div style="font-size:0.85em; color:#666; margin-bottom:4px;"><b>Saved ' + formatDate(hist.date) + '</b></div>';
      if (hist.shortSummary && hist.shortSummary.trim() !== "") {
        html += '<div style="font-style:italic; margin-bottom:4px;">' + esc(hist.shortSummary) + '</div>';
      }
      html += '<div>' + esc(hist.longSummary) + '</div>';
      html += '</div>';
    }
    html += '</div>';
  }

  html += '<br>';
  if (!readOnly) {
    html += '<button onclick="editFullEntry(\'' + entryId + '\')">Edit Annotated Bibliographic Entry</button> ';
    html += '<button onclick="editEntryTopics(\'' + entryId + '\')">Edit Topics</button> ';
    html += '<button onclick="editKeywords(\'' + entryId + '\')">Edit Keywords</button> ';
    html += '<button onclick="editSeeAlso(\'' + entryId + '\')">Edit See Also</button> ';
    html += '<button onclick="confirmDeleteEntry(\'' + entryId + '\')">Delete Entry</button> ';
  }
  html += '<button onclick="window.open(\'https://drive.google.com/drive/folders/1Jp6QuDWOGbeH1GAvguwcKB8v5PbZ3aWi?usp=drive_link\',\'_blank\')">Folder of PDFs</button>';
  if (!readOnly) {
    html += '<div id="edit-area"></div>';
  }
  document.getElementById("content").innerHTML = html;
  document.getElementById("content").scrollTop = 0;
}

function editFullEntry(entryId) {
  var entry = null;
  for (var i = 0; i < entries.length; i++) {
    if (entries[i].id === entryId) { entry = entries[i]; break; }
  }
  if (!entry) return;
  if (!entry.quotations) entry.quotations = [];
  var html = '<div class="edit-section">';

  html += '<label><b>Citation:</b></label>';
  html += '<textarea id="edit-full-citation" rows="3">' + esc(entry.citation) + '</textarea>';

  html += '<label><b>URL / DOI:</b></label>';
  html += '<input type="text" id="edit-full-url" style="width:100%;" value="' + escAttr(entry.url || '') + '">';

  html += '<label><b>Short summary</b> (appears in sub-bibliographies):</label>';
  html += '<textarea id="edit-full-short" rows="3">' + esc(entry.shortSummary) + '</textarea>';

  html += '<label><b>Longer summary:</b></label>';
  html += '<textarea id="edit-full-long" rows="10">' + esc(entry.longSummary) + '</textarea>';

  html += '<label><b>Editorial Notes:</b></label>';
  html += '<textarea id="edit-full-notes" rows="6">' + esc(entry.editorialNotes || '') + '</textarea>';

  // Key Quotations
  html += '<div style="margin-top:12px;"><b>Key Quotations</b></div>';
  for (var q = 0; q < entry.quotations.length; q++) {
    html += '<div id="fe_row_' + q + '" style="margin:8px 0; padding:8px; background:#f5f5f0; border:1px solid #ddd;">';
    html += '<label>Quotation:</label>';
    html += '<textarea id="fe_text_' + q + '" rows="3">' + esc(entry.quotations[q].text) + '</textarea>';
    html += '<label>Page:</label> <input type="text" id="fe_page_' + q + '" style="width:80px;" value="' + escAttr(entry.quotations[q].page || '') + '">';
    html += ' <a onclick="document.getElementById(\'fe_row_' + q + '\').remove()" style="font-size:0.85em; color:#cc0000; cursor:pointer;">[remove]</a>';
    html += '</div>';
  }
  html += '<div id="fe-new-quotation-rows"></div>';
  html += '<div style="margin-top:6px;"><a onclick="addFullEntryQuotationRow()" style="font-size:small; cursor:pointer;">+ Add quotation</a></div>';

  html += '<br><button onclick="saveFullEntry(\'' + entryId + '\')">Save</button> ';
  html += '<button onclick="showEntry(\'' + entryId + '\')">Cancel</button>';
  html += '</div>';
  document.getElementById("edit-area").innerHTML = html;
  window._feExistingQuotationCount = entry.quotations.length;
  window._feNewQuotationCount = 0;
}

function addFullEntryQuotationRow() {
  var div = document.getElementById("fe-new-quotation-rows");
  var n = window._feNewQuotationCount;
  var html = '<div id="fen_row_' + n + '" style="margin:8px 0; padding:8px; background:#f5f5f0; border:1px solid #ddd;">';
  html += '<label>Quotation:</label>';
  html += '<textarea id="fen_text_' + n + '" rows="3" placeholder="Enter the quotation..."></textarea>';
  html += '<label>Page:</label> <input type="text" id="fen_page_' + n + '" style="width:80px;" placeholder="e.g. 42">';
  html += ' <a onclick="document.getElementById(\'fen_row_' + n + '\').remove()" style="font-size:0.85em; color:#cc0000; cursor:pointer;">[remove]</a>';
  html += '</div>';
  div.innerHTML += html;
  window._feNewQuotationCount++;
}

function saveFullEntry(entryId) {
  snapshot();
  var entry = null;
  for (var i = 0; i < entries.length; i++) {
    if (entries[i].id === entryId) { entry = entries[i]; break; }
  }
  if (!entry) return;

  // Save summary history if previous summary had content
  if ((entry.shortSummary && entry.shortSummary.trim() !== '') || (entry.longSummary && entry.longSummary.trim() !== '')) {
    if (!entry.summaryHistory) entry.summaryHistory = [];
    entry.summaryHistory.push({
      date: entry.dateModified || new Date().toISOString(),
      shortSummary: entry.shortSummary || '',
      longSummary: entry.longSummary || ''
    });
  }

  entry.citation = document.getElementById('edit-full-citation').value;
  entry.url = document.getElementById('edit-full-url').value.trim();
  entry.shortSummary = document.getElementById('edit-full-short').value;
  entry.longSummary = document.getElementById('edit-full-long').value;
  entry.editorialNotes = document.getElementById('edit-full-notes').value;

  // Collect quotations
  var updated = [];
  for (var q = 0; q < window._feExistingQuotationCount; q++) {
    var textEl = document.getElementById('fe_text_' + q);
    if (textEl) {
      var text = textEl.value.trim();
      if (text !== '') {
        updated.push({ text: text, page: (document.getElementById('fe_page_' + q) || {}).value || '' });
      }
    }
  }
  for (var n = 0; n < window._feNewQuotationCount; n++) {
    var ntEl = document.getElementById('fen_text_' + n);
    if (ntEl) {
      var nt = ntEl.value.trim();
      if (nt !== '') {
        updated.push({ text: nt, page: (document.getElementById('fen_page_' + n) || {}).value || '' });
      }
    }
  }
  entry.quotations = updated;

  entry.dateModified = new Date().toISOString();
  entries.sort(function(a, b) { return a.citation.localeCompare(b.citation); });
  autoSave();
  showEntry(entryId);
}

function editEntryTopics(entryId) {
  var entry = null;
  for (var i = 0; i < entries.length; i++) {
    if (entries[i].id === entryId) { entry = entries[i]; break; }
  }
  if (!entry) return;
  var html = '<div class="edit-section">';
  html += "<label>Topics for this entry:</label><br><br>";
  for (var i = 0; i < topics.length; i++) {
    var checked = entry.topics.indexOf(topics[i].id) !== -1 ? " checked" : "";
    html += '<div style="margin-bottom:6px"><input type="checkbox" id="et_' + topics[i].id + '"' + checked + '> ' + esc(topics[i].name) + '</div>';
  }
  html += '<br><button onclick="saveEntryTopics(\'' + entryId + '\')">Save</button> ';
  html += '<button onclick="showEntry(\'' + entryId + '\')">Cancel</button>';
  html += '</div>';
  document.getElementById("edit-area").innerHTML = html;
}

function saveEntryTopics(entryId) {
  snapshot();
  var entry = null;
  for (var i = 0; i < entries.length; i++) {
    if (entries[i].id === entryId) { entry = entries[i]; break; }
  }
  if (!entry) return;
  entry.topics = [];
  for (var i = 0; i < topics.length; i++) {
    var cb = document.getElementById("et_" + topics[i].id);
    if (cb && cb.checked) entry.topics.push(topics[i].id);
  }
  entry.dateModified = new Date().toISOString();
  autoSave();
  renderSidebar();
  showEntry(entryId);
}

function editEntry(entryId) {
  var entry = null;
  for (var i = 0; i < entries.length; i++) {
    if (entries[i].id === entryId) { entry = entries[i]; break; }
  }
  if (!entry) return;
  var html = '<div class="edit-section">';
  html += "<label>Short summary (appears in sub-bibliographies):</label>";
  html += '<textarea id="edit-short" rows="3">' + esc(entry.shortSummary) + "</textarea>";
  html += "<label>Long summary:</label>";
  html += '<textarea id="edit-long" rows="10">' + esc(entry.longSummary) + "</textarea>";
  html += '<br><button onclick="saveEntry(\'' + entryId + '\')">Save</button> ';
  html += '<button onclick="showEntry(\'' + entryId + '\')">Cancel</button>';
  html += "</div>";
  document.getElementById("edit-area").innerHTML = html;
}

function saveEntry(entryId) {
  snapshot();
  var entry = null;
  for (var i = 0; i < entries.length; i++) {
    if (entries[i].id === entryId) { entry = entries[i]; break; }
  }
  if (!entry) return;
  // Feature 9: Save previous summary to history if it had content
  if ((entry.shortSummary && entry.shortSummary.trim() !== "") || (entry.longSummary && entry.longSummary.trim() !== "")) {
    if (!entry.summaryHistory) entry.summaryHistory = [];
    entry.summaryHistory.push({
      date: entry.dateModified || new Date().toISOString(),
      shortSummary: entry.shortSummary || "",
      longSummary: entry.longSummary || ""
    });
  }
  entry.shortSummary = document.getElementById("edit-short").value;
  entry.longSummary = document.getElementById("edit-long").value;
  entry.dateModified = new Date().toISOString();
  autoSave();
  showEntry(entryId);
}

function editCitation(entryId) {
  var entry = null;
  for (var i = 0; i < entries.length; i++) {
    if (entries[i].id === entryId) { entry = entries[i]; break; }
  }
  if (!entry) return;
  var html = '<div class="edit-section">';
  html += "<label>Citation:</label>";
  html += '<textarea id="edit-citation" rows="3">' + esc(entry.citation) + "</textarea>";
  html += '<br><button onclick="saveCitation(\'' + entryId + '\')">Save</button> ';
  html += '<button onclick="showEntry(\'' + entryId + '\')">Cancel</button>';
  html += "</div>";
  document.getElementById("edit-area").innerHTML = html;
}

function saveCitation(entryId) {
  snapshot();
  var entry = null;
  for (var i = 0; i < entries.length; i++) {
    if (entries[i].id === entryId) { entry = entries[i]; break; }
  }
  if (!entry) return;
  entry.citation = document.getElementById("edit-citation").value;
  entry.dateModified = new Date().toISOString();
  entries.sort(function(a, b) { return a.citation.localeCompare(b.citation); });
  autoSave();
  showEntry(entryId);
}

// Feature 5: Edit URL/DOI
function editURL(entryId) {
  var entry = null;
  for (var i = 0; i < entries.length; i++) {
    if (entries[i].id === entryId) { entry = entries[i]; break; }
  }
  if (!entry) return;
  var html = '<div class="edit-section">';
  html += "<label>URL / DOI:</label>";
  html += '<input type="text" id="edit-url" style="width:100%;" value="' + escAttr(entry.url || "") + '">';
  html += '<br><button onclick="saveURL(\'' + entryId + '\')">Save</button> ';
  html += '<button onclick="showEntry(\'' + entryId + '\')">Cancel</button>';
  html += "</div>";
  document.getElementById("edit-area").innerHTML = html;
}

function saveURL(entryId) {
  snapshot();
  var entry = null;
  for (var i = 0; i < entries.length; i++) {
    if (entries[i].id === entryId) { entry = entries[i]; break; }
  }
  if (!entry) return;
  entry.url = document.getElementById("edit-url").value.trim();
  entry.dateModified = new Date().toISOString();
  autoSave();
  showEntry(entryId);
}

// --- KEY QUOTATIONS ---

function editQuotations(entryId) {
  var entry = null;
  for (var i = 0; i < entries.length; i++) {
    if (entries[i].id === entryId) { entry = entries[i]; break; }
  }
  if (!entry) return;
  if (!entry.quotations) entry.quotations = [];
  var html = '<div class="edit-section" style="margin-top:8px;">';
  html += '<b>Edit Key Quotations</b><br><br>';
  // Existing quotations
  for (var q = 0; q < entry.quotations.length; q++) {
    html += '<div id="eq_row_' + q + '" style="margin-bottom:10px; padding:8px; background:#f5f5f0; border:1px solid #ddd;">';
    html += '<label>Quotation:</label>';
    html += '<textarea id="eq_text_' + q + '" rows="3">' + esc(entry.quotations[q].text) + '</textarea>';
    html += '<label>Page:</label> <input type="text" id="eq_page_' + q + '" style="width:80px;" value="' + escAttr(entry.quotations[q].page || '') + '">';
    html += ' <a onclick="removeQuotationRow(' + q + ')" style="font-size:0.85em; color:#cc0000; cursor:pointer;">[remove]</a>';
    html += '</div>';
  }
  // Add new quotation area
  html += '<div id="new-quotation-rows"></div>';
  html += '<div style="margin-top:6px;"><a onclick="addNewQuotationRow()" style="font-size:small; cursor:pointer;">+ Add quotation</a></div>';
  html += '<br><button onclick="saveQuotations(\'' + entryId + '\')">Save</button> ';
  html += '<button onclick="showEntry(\'' + entryId + '\')">Cancel</button>';
  html += '</div>';
  document.getElementById("quotation-edit-area").innerHTML = html;
}

var newQuotationCount = 0;
function addNewQuotationRow() {
  var div = document.getElementById("new-quotation-rows");
  var html = '<div id="nq_row_' + newQuotationCount + '" style="margin-bottom:10px; padding:8px; background:#f5f5f0; border:1px solid #ddd;">';
  html += '<label>Quotation:</label>';
  html += '<textarea id="nq_text_' + newQuotationCount + '" rows="3" placeholder="Enter the quotation..."></textarea>';
  html += '<label>Page:</label> <input type="text" id="nq_page_' + newQuotationCount + '" style="width:80px;" placeholder="e.g. 42">';
  html += ' <a onclick="document.getElementById(\'nq_row_' + newQuotationCount + '\').remove()" style="font-size:0.85em; color:#cc0000; cursor:pointer;">[remove]</a>';
  html += '</div>';
  div.innerHTML += html;
  newQuotationCount++;
}

function removeQuotationRow(index) {
  var row = document.getElementById("eq_row_" + index);
  if (row) row.remove();
}

function saveQuotations(entryId) {
  snapshot();
  var entry = null;
  for (var i = 0; i < entries.length; i++) {
    if (entries[i].id === entryId) { entry = entries[i]; break; }
  }
  if (!entry) return;
  // Collect surviving existing quotations
  var updated = [];
  for (var q = 0; q < entry.quotations.length; q++) {
    var textEl = document.getElementById("eq_text_" + q);
    if (textEl) {
      var text = textEl.value.trim();
      if (text !== "") {
        updated.push({
          text: text,
          page: (document.getElementById("eq_page_" + q) || {}).value || ""
        });
      }
    }
  }
  // Collect new quotations
  for (var n = 0; n < newQuotationCount; n++) {
    var ntEl = document.getElementById("nq_text_" + n);
    if (ntEl) {
      var nt = ntEl.value.trim();
      if (nt !== "") {
        updated.push({
          text: nt,
          page: (document.getElementById("nq_page_" + n) || {}).value || ""
        });
      }
    }
  }
  entry.quotations = updated;
  entry.dateModified = new Date().toISOString();
  newQuotationCount = 0;
  autoSave();
  showEntry(entryId);
}

// --- SUMMARY HISTORY (Feature 9) ---

function toggleSummaryHistory(entryId) {
  var div = document.getElementById("summary-history");
  if (div) {
    div.style.display = div.style.display === "none" ? "block" : "none";
  }
}

// --- SEE ALSO ---

function editSeeAlso(entryId) {
  var entry = null;
  for (var i = 0; i < entries.length; i++) {
    if (entries[i].id === entryId) { entry = entries[i]; break; }
  }
  if (!entry) return;
  if (!entry.seeAlso) entry.seeAlso = [];
  var sorted = entries.slice().sort(function(a, b) { return a.citation.localeCompare(b.citation); });
  var html = '<div class="edit-section" style="margin-top:8px; max-height:400px; overflow-y:auto;">';
  html += '<b>Select related entries:</b><br><br>';
  for (var i = 0; i < sorted.length; i++) {
    if (sorted[i].id === entryId) continue;
    var checked = entry.seeAlso.indexOf(sorted[i].id) !== -1 ? " checked" : "";
    html += '<div style="margin-bottom:4px;"><input type="checkbox" id="sa_' + sorted[i].id + '"' + checked + '> ' + esc(sorted[i].citation) + '</div>';
  }
  html += '<br><button onclick="saveSeeAlso(\'' + entryId + '\')">Save</button> ';
  html += '<button onclick="showEntry(\'' + entryId + '\')">Cancel</button>';
  html += '</div>';
  document.getElementById("seealso-edit-area").innerHTML = html;
}

function saveSeeAlso(entryId) {
  snapshot();
  var entry = null;
  for (var i = 0; i < entries.length; i++) {
    if (entries[i].id === entryId) { entry = entries[i]; break; }
  }
  if (!entry) return;
  entry.seeAlso = [];
  for (var i = 0; i < entries.length; i++) {
    if (entries[i].id === entryId) continue;
    var cb = document.getElementById("sa_" + entries[i].id);
    if (cb && cb.checked) entry.seeAlso.push(entries[i].id);
  }
  entry.dateModified = new Date().toISOString();
  autoSave();
  showEntry(entryId);
}

// --- KEYWORDS ---

function editEditorialNotes(entryId) {
  var entry = null;
  for (var i = 0; i < entries.length; i++) {
    if (entries[i].id === entryId) { entry = entries[i]; break; }
  }
  if (!entry) return;
  var html = '<div class="edit-section">';
  html += '<label>Editorial Notes:</label>';
  html += '<textarea id="edit-editorial-notes" rows="8">' + esc(entry.editorialNotes || "") + '</textarea>';
  html += '<br><button onclick="saveEditorialNotes(\'' + entryId + '\')">Save</button> ';
  html += '<button onclick="showEntry(\'' + entryId + '\')">Cancel</button>';
  html += '</div>';
  document.getElementById("edit-area").innerHTML = html;
}

function saveEditorialNotes(entryId) {
  snapshot();
  var entry = null;
  for (var i = 0; i < entries.length; i++) {
    if (entries[i].id === entryId) { entry = entries[i]; break; }
  }
  if (!entry) return;
  entry.editorialNotes = document.getElementById("edit-editorial-notes").value;
  entry.dateModified = new Date().toISOString();
  autoSave();
  showEntry(entryId);
}

function editKeywords(entryId) {
  var entry = null;
  for (var i = 0; i < entries.length; i++) {
    if (entries[i].id === entryId) { entry = entries[i]; break; }
  }
  if (!entry) return;
  if (!entry.keywords) entry.keywords = [];
  var allKw = getAllKeywords();
  var html = '<div class="edit-section">';
  html += '<label>Keywords (comma-separated):</label>';
  html += '<input type="text" id="edit-keywords" style="width:100%;" value="' + escAttr(entry.keywords.join(", ")) + '" placeholder="e.g. color perception, empirical, Berlin & Kay" oninput="showKeywordSuggestions()" onkeydown="handleKeywordSuggestionKey(event)">';
  html += '<div id="keyword-suggestions" style="border:1px solid #ccc; max-height:150px; overflow-y:auto; display:none; background:#fff; position:relative; z-index:10;"></div>';
  html += '<br><button onclick="saveKeywords(\'' + entryId + '\')">Save</button> ';
  html += '<button onclick="showEntry(\'' + entryId + '\')">Cancel</button>';
  if (allKw.length > 0) {
    html += '<div style="margin-top:12px; padding-top:8px; border-top:1px solid #ddd;">';
    html += '<div style="font-size:0.9em; color:#666; margin-bottom:6px;">Existing keywords (click to add):</div>';
    for (var k = 0; k < allKw.length; k++) {
      html += '<span onclick="appendKeywordToInput(' + k + ')" style="display:inline-block; background:#e8e4d8; padding:2px 8px; margin:2px 4px 2px 0; font-size:0.85em; border-radius:3px; cursor:pointer;">' + esc(allKw[k].keyword) + ' <span style="color:#888;">(' + allKw[k].count + ')</span></span>';
    }
    html += '</div>';
  }
  html += '</div>';
  document.getElementById("edit-area").innerHTML = html;
  window._allKwList = allKw;
}

function appendKeywordToInput(idx) {
  var kw = window._allKwList[idx].keyword;
  var input = document.getElementById("edit-keywords");
  var val = input.value.trim();
  // Check if already present
  var parts = val.split(",").map(function(s) { return s.trim().toLowerCase(); });
  if (parts.indexOf(kw.toLowerCase()) !== -1) return;
  if (val !== "" && !val.endsWith(",")) val += ", ";
  else if (val.endsWith(",")) val += " ";
  input.value = val + kw;
  input.focus();
}

function showKeywordSuggestions() {
  var input = document.getElementById("edit-keywords");
  var sugDiv = document.getElementById("keyword-suggestions");
  var val = input.value;
  // Get the current keyword being typed (after last comma)
  var parts = val.split(",");
  var current = parts[parts.length - 1].trim().toLowerCase();
  if (current.length < 1) { sugDiv.style.display = "none"; return; }
  // Get already-entered keywords to exclude
  var existing = {};
  for (var i = 0; i < parts.length - 1; i++) {
    existing[parts[i].trim().toLowerCase()] = true;
  }
  var allKw = getAllKeywords();
  window._kwSuggestions = [];
  for (var i = 0; i < allKw.length; i++) {
    var kwLower = allKw[i].keyword.toLowerCase();
    if (kwLower.indexOf(current) !== -1 && !existing[kwLower]) {
      window._kwSuggestions.push({ keyword: allKw[i].keyword, count: allKw[i].count });
    }
  }
  if (window._kwSuggestions.length === 0 || (window._kwSuggestions.length === 1 && window._kwSuggestions[0].keyword.toLowerCase() === current)) {
    sugDiv.style.display = "none";
    return;
  }
  var html = "";
  for (var i = 0; i < window._kwSuggestions.length && i < 10; i++) {
    html += '<div class="kw-suggestion" onclick="acceptKeywordSuggestion(' + i + ')" style="padding:3px 6px; cursor:pointer; font-size:0.95em;" onmouseover="this.style.background=\'#e8e4d8\'" onmouseout="this.style.background=\'#fff\'">' + esc(window._kwSuggestions[i].keyword) + ' <span style="color:#888;">(' + window._kwSuggestions[i].count + ')</span></div>';
  }
  sugDiv.innerHTML = html;
  sugDiv.style.display = "block";
}

function acceptKeywordSuggestion(idx) {
  var kw = window._kwSuggestions[idx].keyword;
  var input = document.getElementById("edit-keywords");
  var parts = input.value.split(",");
  parts[parts.length - 1] = " " + kw;
  input.value = parts.join(",") + ", ";
  document.getElementById("keyword-suggestions").style.display = "none";
  input.focus();
}

function handleKeywordSuggestionKey(event) {
  if (event.key === "Escape") {
    document.getElementById("keyword-suggestions").style.display = "none";
  }
}

function saveKeywords(entryId) {
  snapshot();
  var entry = null;
  for (var i = 0; i < entries.length; i++) {
    if (entries[i].id === entryId) { entry = entries[i]; break; }
  }
  if (!entry) return;
  var raw = document.getElementById("edit-keywords").value;
  var parts = raw.split(",");
  entry.keywords = [];
  for (var i = 0; i < parts.length; i++) {
    var kw = parts[i].trim();
    if (kw !== "") entry.keywords.push(kw);
  }
  entry.dateModified = new Date().toISOString();
  autoSave();
  showEntry(entryId);
}

function getAllKeywords() {
  var kwMap = {};
  for (var i = 0; i < entries.length; i++) {
    if (!entries[i].keywords) continue;
    for (var k = 0; k < entries[i].keywords.length; k++) {
      var kw = entries[i].keywords[k];
      if (!kwMap[kw]) kwMap[kw] = 0;
      kwMap[kw]++;
    }
  }
  var list = [];
  for (var kw in kwMap) {
    list.push({ keyword: kw, count: kwMap[kw] });
  }
  list.sort(function(a, b) { return a.keyword.localeCompare(b.keyword); });
  return list;
}

function showKeywordBrowser() {
  var resultsDiv = document.getElementById("keyword-browse-results");
  if (resultsDiv.innerHTML !== "") {
    resultsDiv.innerHTML = "";
    return;
  }
  var allKw = getAllKeywords();
  if (allKw.length === 0) {
    resultsDiv.innerHTML = '<div style="color:#888; margin:6px 0;">No keywords have been added yet.</div>';
    return;
  }
  var html = '<div style="margin-top:6px;">';
  for (var i = 0; i < allKw.length; i++) {
    html += '<a onclick="filterByKeyword(\'' + escAttr(allKw[i].keyword) + '\')" style="display:inline-block; background:#e8e4d8; padding:2px 8px; margin:3px 4px; font-size:0.85em; border-radius:3px; cursor:pointer;">' + esc(allKw[i].keyword) + ' <span style="color:#666;">(' + allKw[i].count + ')</span></a>';
  }
  html += '</div>';
  resultsDiv.innerHTML = html;
}

function filterByKeyword(kw) {
  var resultsDiv = document.getElementById("keyword-browse-results");
  var html = '<div style="margin-top:6px;"><b>Entries tagged &ldquo;' + esc(kw) + '&rdquo;:</b> <a onclick="showKeywordBrowser()" style="font-size:0.85em; cursor:pointer;">[back to all keywords]</a></div>';
  var sorted = entries.slice().sort(function(a, b) { return a.citation.localeCompare(b.citation); });
  var count = 0;
  for (var i = 0; i < sorted.length; i++) {
    if (!sorted[i].keywords) continue;
    if (sorted[i].keywords.indexOf(kw) !== -1) {
      count++;
      html += '<div class="entry" style="margin:4px 0;"><a onclick="showEntryFromHome(\'' + sorted[i].id + '\')">' + esc(sorted[i].citation) + '</a></div>';
    }
  }
  if (count === 0) {
    html += '<div style="color:#888;">No entries found.</div>';
  }
  resultsDiv.innerHTML = html;
}

function showBulkKeywordEdit() {
  var area = document.getElementById("bulk-keyword-area");
  if (area.innerHTML !== "") { area.innerHTML = ""; return; }
  var sorted = entries.slice().sort(function(a, b) { return a.citation.localeCompare(b.citation); });
  var html = '<div class="edit-section" style="margin-top:8px;">';
  html += '<label>Keyword to add or remove:</label>';
  html += '<input type="text" id="bulk-kw-value" placeholder="e.g. empirical">';
  html += '<div style="margin:8px 0;"><button onclick="bulkSelectAll(true)">Select all</button> <button onclick="bulkSelectAll(false)">Deselect all</button> <button onclick="bulkSelectByKeyword()">Select entries with keyword</button></div>';
  html += '<div style="max-height:400px; overflow-y:auto; border:1px solid #ccc; padding:6px;">';
  for (var i = 0; i < sorted.length; i++) {
    var kwDisplay = (sorted[i].keywords && sorted[i].keywords.length > 0) ? ' <span style="font-size:0.8em; color:#666;">[' + esc(sorted[i].keywords.join(", ")) + ']</span>' : '';
    html += '<div style="margin-bottom:4px;"><input type="checkbox" class="bulk-kw-check" value="' + escAttr(sorted[i].id) + '"> ' + esc(sorted[i].citation) + kwDisplay + '</div>';
  }
  html += '</div>';
  html += '<br><button onclick="bulkKeywordAdd()">Add keyword to selected</button> ';
  html += '<button onclick="bulkKeywordRemove()">Remove keyword from selected</button> ';
  html += '<button onclick="document.getElementById(\'bulk-keyword-area\').innerHTML=\'\'">Cancel</button>';
  html += '</div>';
  area.innerHTML = html;
}

function bulkSelectAll(state) {
  var cbs = document.querySelectorAll(".bulk-kw-check");
  for (var i = 0; i < cbs.length; i++) cbs[i].checked = state;
}

function bulkSelectByKeyword() {
  var kw = document.getElementById("bulk-kw-value").value.trim();
  if (kw === "") return;
  var cbs = document.querySelectorAll(".bulk-kw-check");
  for (var i = 0; i < cbs.length; i++) {
    var entryId = cbs[i].value;
    for (var e = 0; e < entries.length; e++) {
      if (entries[e].id === entryId) {
        cbs[i].checked = (entries[e].keywords && entries[e].keywords.indexOf(kw) !== -1);
        break;
      }
    }
  }
}

function bulkKeywordAdd() {
  var kw = document.getElementById("bulk-kw-value").value.trim();
  if (kw === "") { alert("Please enter a keyword."); return; }
  snapshot();
  var cbs = document.querySelectorAll(".bulk-kw-check");
  var count = 0;
  for (var i = 0; i < cbs.length; i++) {
    if (!cbs[i].checked) continue;
    var entryId = cbs[i].value;
    for (var e = 0; e < entries.length; e++) {
      if (entries[e].id === entryId) {
        if (!entries[e].keywords) entries[e].keywords = [];
        if (entries[e].keywords.indexOf(kw) === -1) {
          entries[e].keywords.push(kw);
          entries[e].dateModified = new Date().toISOString();
          count++;
        }
        break;
      }
    }
  }
  autoSave();
  showHome();
}

function bulkKeywordRemove() {
  var kw = document.getElementById("bulk-kw-value").value.trim();
  if (kw === "") { alert("Please enter a keyword."); return; }
  snapshot();
  var cbs = document.querySelectorAll(".bulk-kw-check");
  var count = 0;
  for (var i = 0; i < cbs.length; i++) {
    if (!cbs[i].checked) continue;
    var entryId = cbs[i].value;
    for (var e = 0; e < entries.length; e++) {
      if (entries[e].id === entryId) {
        if (entries[e].keywords) {
          var idx = entries[e].keywords.indexOf(kw);
          if (idx !== -1) {
            entries[e].keywords.splice(idx, 1);
            entries[e].dateModified = new Date().toISOString();
            count++;
          }
        }
        break;
      }
    }
  }
  autoSave();
  showHome();
}

function confirmDeleteEntry(entryId) {
  var html = '<div class="edit-section">';
  html += 'Are you sure you want to delete this entry? ';
  html += '<button onclick="deleteEntry(\'' + entryId + '\')">Yes, delete</button> ';
  html += '<button onclick="showEntry(\'' + entryId + '\')">Cancel</button>';
  html += '</div>';
  document.getElementById("edit-area").innerHTML = html;
}

function deleteEntry(entryId) {
  snapshot();
  for (var i = 0; i < entries.length; i++) {
    if (entries[i].id === entryId) {
      entries.splice(i, 1);
      break;
    }
  }
  // Clean up seeAlso references from other entries
  for (var j = 0; j < entries.length; j++) {
    if (entries[j].seeAlso) {
      var idx = entries[j].seeAlso.indexOf(entryId);
      if (idx !== -1) entries[j].seeAlso.splice(idx, 1);
    }
  }
  autoSave();
  renderSidebar();
  if (navHistory.length > 0) {
    goBack();
  } else {
    showHome();
  }
}

// --- EXPORT PDF ---

function exportPDF() {
  var jsPDF = window.jspdf.jsPDF;
  var doc = new jsPDF();
  var pageWidth = doc.internal.pageSize.getWidth();
  var margin = 20;
  var maxWidth = pageWidth - margin * 2;
  var y = margin;
  var lineHeight = 6;

  doc.setFontSize(16);
  doc.text("Zed's Annotated Bibliography on Color", margin, y);
  y += 12;

  doc.setFontSize(11);

  var sorted = entries.slice().sort(function(a, b) {
    return a.citation.localeCompare(b.citation);
  });

  for (var i = 0; i < sorted.length; i++) {
    var entry = sorted[i];
    if (!entry.longSummary || entry.longSummary.trim() === "") continue;

    doc.setFont("helvetica", "bold");
    var citationLines = doc.splitTextToSize(entry.citation, maxWidth);
    var blockHeight = (citationLines.length + 1) * lineHeight;

    doc.setFont("helvetica", "normal");
    var summaryLines = doc.splitTextToSize(entry.longSummary, maxWidth);
    blockHeight += summaryLines.length * lineHeight + 8;

    if (y + blockHeight > doc.internal.pageSize.getHeight() - margin) {
      doc.addPage();
      y = margin;
    }

    doc.setFont("helvetica", "bold");
    doc.text(citationLines, margin, y);
    y += citationLines.length * lineHeight + 2;

    doc.setFont("helvetica", "normal");
    doc.text(summaryLines, margin, y);
    y += summaryLines.length * lineHeight + 10;
  }

  doc.save("bibliography_summaries.pdf");
}

function exportQuotationsPDF() {
  var jsPDF = window.jspdf.jsPDF;
  var doc = new jsPDF();
  var pageWidth = doc.internal.pageSize.getWidth();
  var margin = 20;
  var maxWidth = pageWidth - margin * 2;
  var y = margin;
  var lineHeight = 6;

  doc.setFontSize(16);
  doc.text("Key Quotations", margin, y);
  y += 12;

  var sorted = entries.slice().sort(function(a, b) {
    return a.citation.localeCompare(b.citation);
  });

  var anyQuotations = false;

  for (var i = 0; i < sorted.length; i++) {
    var entry = sorted[i];
    if (!entry.quotations || entry.quotations.length === 0) continue;
    anyQuotations = true;

    // Citation header (bold)
    doc.setFontSize(11);
    doc.setFont("helvetica", "bold");
    var citationLines = doc.splitTextToSize(entry.citation, maxWidth);
    var blockHeight = citationLines.length * lineHeight + 4;

    // Estimate quotation height
    doc.setFont("helvetica", "italic");
    for (var q = 0; q < entry.quotations.length; q++) {
      var qText = "\u201C" + entry.quotations[q].text + "\u201D";
      if (entry.quotations[q].page && entry.quotations[q].page.trim() !== "") {
        qText += " (p. " + entry.quotations[q].page + ")";
      }
      var qLines = doc.splitTextToSize(qText, maxWidth - 10);
      blockHeight += qLines.length * lineHeight + 4;
    }
    blockHeight += 6;

    if (y + blockHeight > doc.internal.pageSize.getHeight() - margin) {
      doc.addPage();
      y = margin;
    }

    // Print citation
    doc.setFont("helvetica", "bold");
    doc.setFontSize(11);
    doc.text(citationLines, margin, y);
    y += citationLines.length * lineHeight + 2;

    // Print each quotation
    doc.setFont("helvetica", "italic");
    doc.setFontSize(10);
    for (var q = 0; q < entry.quotations.length; q++) {
      var qText = "\u201C" + entry.quotations[q].text + "\u201D";
      if (entry.quotations[q].page && entry.quotations[q].page.trim() !== "") {
        doc.setFont("helvetica", "italic");
        qText += " (p. " + entry.quotations[q].page + ")";
      }
      var qLines = doc.splitTextToSize(qText, maxWidth - 10);
      if (y + qLines.length * lineHeight > doc.internal.pageSize.getHeight() - margin) {
        doc.addPage();
        y = margin;
      }
      doc.text(qLines, margin + 5, y);
      y += qLines.length * lineHeight + 4;
    }
    y += 6;
  }

  if (!anyQuotations) {
    doc.setFontSize(11);
    doc.setFont("helvetica", "normal");
    doc.text("No key quotations have been saved yet.", margin, y);
  }

  doc.save("key_quotations.pdf");
}

// --- Feature 6: EXPORT BIBTEX ---

function exportTopicPDF(topicId) {
  var topicName = "";
  for (var i = 0; i < topics.length; i++) {
    if (topics[i].id === topicId) { topicName = topics[i].name; break; }
  }
  var topicEntries = [];
  for (var i = 0; i < entries.length; i++) {
    if (entries[i].topics.indexOf(topicId) !== -1) {
      topicEntries.push(entries[i]);
    }
  }
  topicEntries.sort(function(a, b) { return a.citation.localeCompare(b.citation); });

  var jsPDF = window.jspdf.jsPDF;
  var doc = new jsPDF();
  var pageWidth = doc.internal.pageSize.getWidth();
  var margin = 20;
  var maxWidth = pageWidth - margin * 2;
  var y = margin;
  var lineHeight = 6;

  doc.setFontSize(16);
  doc.text(topicName, margin, y);
  y += 12;

  doc.setFontSize(11);
  doc.setFont("helvetica", "normal");

  for (var i = 0; i < topicEntries.length; i++) {
    var citationLines = doc.splitTextToSize(topicEntries[i].citation, maxWidth);
    var blockHeight = citationLines.length * lineHeight + 4;

    if (y + blockHeight > doc.internal.pageSize.getHeight() - margin) {
      doc.addPage();
      y = margin;
    }

    doc.text(citationLines, margin, y);
    y += citationLines.length * lineHeight + 4;
  }

  var filename = topicName.toLowerCase().replace(/[^a-z0-9]+/g, "_") + "_bibliography.pdf";
  doc.save(filename);
}

function exportBibTeX() {
  var lines = [];
  var usedKeys = {};

  for (var i = 0; i < entries.length; i++) {
    var e = entries[i];
    var author = "";
    var year = "";
    var title = "";

    // Extract year from "(YYYY)"
    var yearMatch = e.citation.match(/\((\d{4})\)/);
    if (yearMatch) year = yearMatch[1];

    // Extract author (everything before the year parenthetical)
    var authorMatch = e.citation.match(/^(.+?)\s*\(\d{4}\)/);
    if (authorMatch) author = authorMatch[1].replace(/,\s*$/, "").trim();

    // Extract title (text after "YYYY). " up to next period-space or end)
    var titleMatch = e.citation.match(/\(\d{4}\)\.\s*(.+?)(?:\.\s|$)/);
    if (titleMatch) title = titleMatch[1].trim().replace(/\.$/, "");

    // Generate cite key: first author last name + year
    var lastName = author.split(",")[0].trim().replace(/[^a-zA-Z]/g, "").toLowerCase();
    var citeKey = (lastName || "unknown") + (year || "0000");

    // Ensure unique keys with a, b, c suffixes
    var baseKey = citeKey;
    var suffix = 0;
    while (usedKeys[citeKey]) {
      suffix++;
      citeKey = baseKey + String.fromCharCode(96 + suffix);
    }
    usedKeys[citeKey] = true;

    var bib = "@misc{" + citeKey + ",\n";
    bib += "  author = {" + author + "},\n";
    bib += "  year = {" + year + "},\n";
    bib += "  title = {" + title + "}";
    if (e.url && e.url.trim() !== "") {
      bib += ",\n  url = {" + e.url + "}";
    }
    bib += "\n}";
    lines.push(bib);
  }

  var text = lines.join("\n\n") + "\n";
  var blob = new Blob([text], { type: "text/plain" });
  var a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "bibliography.bib";
  a.click();
}

function importBibTeX(event) {
  var file = event.target.files[0];
  if (!file) return;
  var reader = new FileReader();
  reader.onload = function(e) {
    var text = e.target.result;
    var parsed = parseBibTeX(text);
    if (parsed.length === 0) {
      alert("No valid BibTeX entries found in file.");
      event.target.value = "";
      return;
    }
    showBibTeXImportPreview(parsed);
    event.target.value = "";
  };
  reader.readAsText(file);
}

function parseBibTeX(text) {
  var results = [];
  // Match each @type{...} entry
  var i = 0;
  while (i < text.length) {
    var atIdx = text.indexOf("@", i);
    if (atIdx === -1) break;
    // Get entry type
    var typeEnd = text.indexOf("{", atIdx);
    if (typeEnd === -1) break;
    var entryType = text.substring(atIdx + 1, typeEnd).trim().toLowerCase();
    if (entryType === "string" || entryType === "preamble" || entryType === "comment") {
      i = typeEnd + 1;
      continue;
    }
    // Find matching closing brace
    var depth = 1;
    var j = typeEnd + 1;
    while (j < text.length && depth > 0) {
      if (text[j] === "{") depth++;
      else if (text[j] === "}") depth--;
      j++;
    }
    var body = text.substring(typeEnd + 1, j - 1);
    // Remove cite key (everything before first comma)
    var commaIdx = body.indexOf(",");
    if (commaIdx === -1) { i = j; continue; }
    var fieldsStr = body.substring(commaIdx + 1);
    // Parse fields
    var fields = parseBibFields(fieldsStr);
    fields._type = entryType;
    results.push(fields);
    i = j;
  }
  return results;
}

function parseBibFields(str) {
  var fields = {};
  var i = 0;
  while (i < str.length) {
    // Skip whitespace and commas
    while (i < str.length && (str[i] === " " || str[i] === "\n" || str[i] === "\r" || str[i] === "\t" || str[i] === ",")) i++;
    if (i >= str.length) break;
    // Read field name
    var eqIdx = str.indexOf("=", i);
    if (eqIdx === -1) break;
    var fieldName = str.substring(i, eqIdx).trim().toLowerCase();
    i = eqIdx + 1;
    // Skip whitespace
    while (i < str.length && (str[i] === " " || str[i] === "\t")) i++;
    if (i >= str.length) break;
    // Read value
    var value = "";
    if (str[i] === "{") {
      var depth = 1;
      var start = i + 1;
      i++;
      while (i < str.length && depth > 0) {
        if (str[i] === "{") depth++;
        else if (str[i] === "}") depth--;
        i++;
      }
      value = str.substring(start, i - 1);
    } else if (str[i] === '"') {
      i++;
      var start = i;
      while (i < str.length && str[i] !== '"') {
        if (str[i] === "\\" && i + 1 < str.length) i++;
        i++;
      }
      value = str.substring(start, i);
      i++;
    } else {
      var start = i;
      while (i < str.length && str[i] !== "," && str[i] !== "}" && str[i] !== "\n") i++;
      value = str.substring(start, i).trim();
    }
    // Clean LaTeX commands
    value = cleanLaTeX(value);
    fields[fieldName] = value;
  }
  return fields;
}

function cleanLaTeX(s) {
  return s
    .replace(/\\&/g, "&")
    .replace(/\\\$/g, "$")
    .replace(/\\%/g, "%")
    .replace(/\\_/g, "_")
    .replace(/\\#/g, "#")
    .replace(/\\textit\{([^}]*)\}/g, "$1")
    .replace(/\\textbf\{([^}]*)\}/g, "$1")
    .replace(/\\emph\{([^}]*)\}/g, "$1")
    .replace(/\\text\{([^}]*)\}/g, "$1")
    .replace(/\{([^{}]*)\}/g, "$1")
    .replace(/~/g, " ")
    .replace(/``/g, "\u201C").replace(/''/g, "\u201D")
    .replace(/--/g, "\u2013")
    .trim();
}

function bibFieldsToCitation(f) {
  var author = f.author || "Unknown";
  var year = f.year || "n.d.";
  var title = f.title || "Untitled";
  // Clean trailing period from title
  title = title.replace(/\.\s*$/, "");
  var citation = author + " (" + year + "). " + title + ".";
  var type = f._type || "misc";
  if (type === "article") {
    if (f.journal) {
      citation += " " + f.journal;
      if (f.volume) citation += ", " + f.volume;
      if (f.number) citation += "(" + f.number + ")";
      if (f.pages) citation += ", " + f.pages;
      citation += ".";
    }
  } else if (type === "incollection" || type === "inproceedings") {
    if (f.booktitle) {
      citation += " In " + f.booktitle;
      if (f.editor) citation += " (Ed. " + f.editor + ")";
      if (f.pages) citation += ", pp. " + f.pages;
      citation += ".";
    }
    if (f.publisher) citation += " " + f.publisher + ".";
  } else if (type === "book") {
    if (f.publisher) citation += " " + f.publisher + ".";
    if (f.address) citation += " " + f.address + ".";
  } else if (type === "phdthesis" || type === "mastersthesis") {
    citation += " Doctoral dissertation.";
    if (f.school) citation += " " + f.school + ".";
  }
  return citation;
}

function showBibTeXImportPreview(parsed) {
  navHistory = [];
  clearActive();
  var content = document.getElementById("content");
  var html = '<h3>Import from BibTeX \u2014 ' + parsed.length + ' entries found</h3>';
  html += '<div style="margin-bottom:10px;">';
  html += '<label>Add all to topic: </label>';
  html += '<select id="import-topic-select">';
  html += '<option value="">(Uncategorized)</option>';
  for (var t = 0; t < topics.length; t++) {
    html += '<option value="' + esc(topics[t]) + '">' + esc(topics[t]) + '</option>';
  }
  html += '</select></div>';
  html += '<div style="margin-bottom:10px;"><input type="checkbox" id="import-skip-dupes" checked> Skip entries whose title already exists in bibliography</div>';
  for (var i = 0; i < parsed.length; i++) {
    var cit = bibFieldsToCitation(parsed[i]);
    var kw = parsed[i].keywords || "";
    html += '<div style="margin:6px 0; padding:6px; border:1px solid #ccc;">';
    html += '<input type="checkbox" class="import-check" data-idx="' + i + '" checked> ';
    html += '<span style="font-size:0.95em;">' + esc(cit) + '</span>';
    if (kw) html += '<br><span style="font-size:0.8em; color:#666;">Keywords: ' + esc(kw) + '</span>';
    html += '</div>';
  }
  html += '<br><button onclick="doImportBibTeX()">Import Selected</button> ';
  html += '<button onclick="showHome()">Cancel</button>';
  content.innerHTML = html;
  // Stash parsed data
  window._importBibData = parsed;
}

function doImportBibTeX() {
  snapshot();
  var parsed = window._importBibData;
  if (!parsed) return;
  var topicVal = document.getElementById("import-topic-select").value;
  var skipDupes = document.getElementById("import-skip-dupes").checked;
  var checks = document.querySelectorAll(".import-check");
  var imported = 0;
  var skipped = 0;
  for (var c = 0; c < checks.length; c++) {
    if (!checks[c].checked) continue;
    var idx = parseInt(checks[c].getAttribute("data-idx"));
    var f = parsed[idx];
    var citation = bibFieldsToCitation(f);
    // Check for duplicates by normalized title
    if (skipDupes && f.title) {
      var normTitle = f.title.toLowerCase().replace(/[^a-z0-9]/g, "");
      var isDupe = false;
      for (var e = 0; e < entries.length; e++) {
        var existingTitle = (entries[e].citation || "").toLowerCase().replace(/[^a-z0-9]/g, "");
        if (existingTitle.indexOf(normTitle) !== -1 && normTitle.length > 10) {
          isDupe = true;
          break;
        }
      }
      if (isDupe) { skipped++; continue; }
    }
    var url = f.url || f.doi || "";
    if (url && url.indexOf("http") !== 0 && f.doi) {
      url = "https://doi.org/" + url;
    }
    // Parse keywords from BibTeX keywords field
    var kwArr = [];
    if (f.keywords) {
      var kwParts = f.keywords.split(/[;,]/);
      for (var k = 0; k < kwParts.length; k++) {
        var kw = kwParts[k].trim();
        if (kw !== "") kwArr.push(kw);
      }
    }
    var newEntry = {
      id: generateId(),
      citation: citation,
      shortSummary: "",
      longSummary: f.abstract || "",
      dateAdded: new Date().toISOString(),
      dateModified: new Date().toISOString(),
      topics: topicVal ? [topicVal] : [],
      url: url,
      quotations: [],
      summaryHistory: [],
      seeAlso: [],
      keywords: kwArr,
    editorialNotes: ""
    };
    entries.push(newEntry);
    imported++;
  }
  autoSave();
  renderSidebar();
  alert("Imported " + imported + " entries." + (skipped > 0 ? " Skipped " + skipped + " potential duplicates." : ""));
  showHome();
  window._importBibData = null;
}

// --- CLEAR YEAR RANGE ---
function clearYearRange() {
  var yf = document.getElementById("year-from");
  var yt = document.getElementById("year-to");
  if (yf) yf.value = "";
  if (yt) yt.value = "";
  filterEntries();
}

// --- STATISTICS PAGE ---
function showStatistics() {
  navHistory = [];
  clearActive();
  var content = document.getElementById("content");

  // Entry counts by topic
  var topicCounts = {};
  for (var t = 0; t < topics.length; t++) {
    topicCounts[topics[t].id] = { name: topics[t].name, count: 0 };
  }
  var uncategorized = 0;
  var withSummary = 0, withLongSummary = 0, withQuotations = 0, withEditorialNotes = 0, withKeywords = 0, withURL = 0;
  var yearDist = {};
  var addedByMonth = {};

  for (var i = 0; i < entries.length; i++) {
    var e = entries[i];
    if (e.topics.length === 0) uncategorized++;
    for (var t = 0; t < e.topics.length; t++) {
      if (topicCounts[e.topics[t]]) topicCounts[e.topics[t]].count++;
    }
    if (e.shortSummary && e.shortSummary.trim() !== "") withSummary++;
    if (e.longSummary && e.longSummary.trim() !== "") withLongSummary++;
    if (e.quotations && e.quotations.length > 0) withQuotations++;
    if (e.editorialNotes && e.editorialNotes.trim() !== "") withEditorialNotes++;
    if (e.keywords && e.keywords.length > 0) withKeywords++;
    if (e.url && e.url.trim() !== "") withURL++;

    var year = extractYear(e.citation);
    if (year > 0) {
      if (!yearDist[year]) yearDist[year] = 0;
      yearDist[year]++;
    }

    if (e.dateAdded) {
      var mo = e.dateAdded.substring(0, 7); // YYYY-MM
      if (!addedByMonth[mo]) addedByMonth[mo] = 0;
      addedByMonth[mo]++;
    }
  }

  var html = '<div><b>Statistics</b></div><br>';
  html += '<div style="margin-bottom:16px;"><b>Overview</b>';
  html += '<div style="margin-left:16px; margin-top:4px;">';
  html += 'Total entries: ' + entries.length + '<br>';
  html += 'With one-sentence summary: ' + withSummary + ' (' + pct(withSummary, entries.length) + ')<br>';
  html += 'With longer summary: ' + withLongSummary + ' (' + pct(withLongSummary, entries.length) + ')<br>';
  html += 'With key quotations: ' + withQuotations + ' (' + pct(withQuotations, entries.length) + ')<br>';
  html += 'With editorial notes: ' + withEditorialNotes + ' (' + pct(withEditorialNotes, entries.length) + ')<br>';
  html += 'With keywords: ' + withKeywords + ' (' + pct(withKeywords, entries.length) + ')<br>';
  html += 'With URL: ' + withURL + ' (' + pct(withURL, entries.length) + ')<br>';
  html += 'Uncategorized: ' + uncategorized + '<br>';
  html += '</div></div>';

  // Topics
  html += '<div style="margin-bottom:16px;"><b>Entries by Topic</b>';
  html += '<div style="margin-left:16px; margin-top:4px;">';
  var topicList = [];
  for (var id in topicCounts) {
    topicList.push(topicCounts[id]);
  }
  topicList.sort(function(a, b) { return b.count - a.count; });
  for (var t = 0; t < topicList.length; t++) {
    html += esc(topicList[t].name) + ': ' + topicList[t].count + '<br>';
  }
  html += '</div></div>';

  // Year distribution
  var years = [];
  for (var y in yearDist) years.push(parseInt(y));
  years.sort();
  if (years.length > 0) {
    html += '<div style="margin-bottom:16px;"><b>Publication Year Distribution</b>';
    html += '<div style="margin-left:16px; margin-top:4px;">';
    // Group by decade
    var decades = {};
    for (var yi = 0; yi < years.length; yi++) {
      var decade = Math.floor(years[yi] / 10) * 10;
      if (!decades[decade]) decades[decade] = 0;
      decades[decade] += yearDist[years[yi]];
    }
    var decadeKeys = Object.keys(decades).sort();
    for (var d = 0; d < decadeKeys.length; d++) {
      var dk = decadeKeys[d];
      var bar = '';
      for (var b = 0; b < decades[dk]; b++) bar += '\u2588';
      html += dk + 's: ' + bar + ' (' + decades[dk] + ')<br>';
    }
    html += '<br>Year range: ' + years[0] + '\u2013' + years[years.length - 1] + '<br>';
    html += '</div></div>';
  }

  // Added by month
  var months = Object.keys(addedByMonth).sort();
  if (months.length > 0) {
    html += '<div style="margin-bottom:16px;"><b>Entries Added by Month</b>';
    html += '<div style="margin-left:16px; margin-top:4px;">';
    for (var m = 0; m < months.length; m++) {
      var bar = '';
      for (var b = 0; b < addedByMonth[months[m]]; b++) bar += '\u2588';
      html += months[m] + ': ' + bar + ' (' + addedByMonth[months[m]] + ')<br>';
    }
    html += '</div></div>';
  }

  // Keyword frequency
  var allKw = getAllKeywords();
  if (allKw.length > 0) {
    html += '<div style="margin-bottom:16px;"><b>Top Keywords</b>';
    html += '<div style="margin-left:16px; margin-top:4px;">';
    var kwSorted = allKw.slice().sort(function(a, b) { return b.count - a.count; });
    var kwLimit = Math.min(kwSorted.length, 30);
    for (var k = 0; k < kwLimit; k++) {
      html += esc(kwSorted[k].keyword) + ': ' + kwSorted[k].count + '<br>';
    }
    if (kwSorted.length > 30) html += '... and ' + (kwSorted.length - 30) + ' more keywords<br>';
    html += '</div></div>';
  }

  content.innerHTML = html;
  content.scrollTop = 0;
}

function pct(n, total) {
  if (total === 0) return "0%";
  return Math.round(n / total * 100) + "%";
}

// --- EXPORT COMPLETE PDF ---
function exportCompletePDF() {
  var jsPDF = window.jspdf.jsPDF;
  var doc = new jsPDF();
  var pageWidth = doc.internal.pageSize.getWidth();
  var pageHeight = doc.internal.pageSize.getHeight();
  var margin = 20;
  var maxWidth = pageWidth - margin * 2;
  var y = margin;
  var lineHeight = 5.5;

  doc.setFontSize(16);
  doc.text("Zed's Annotated Bibliography on Color", margin, y);
  y += 8;
  doc.setFontSize(10);
  doc.setFont("helvetica", "normal");
  doc.text("Complete export \u2014 " + entries.length + " entries \u2014 " + new Date().toLocaleDateString(), margin, y);
  y += 12;

  var sorted = entries.slice().sort(function(a, b) {
    return a.citation.localeCompare(b.citation);
  });

  doc.setFontSize(10);

  for (var i = 0; i < sorted.length; i++) {
    var entry = sorted[i];

    // Estimate block height
    doc.setFont("helvetica", "bold");
    var citLines = doc.splitTextToSize(entry.citation, maxWidth);
    var blockH = citLines.length * lineHeight + 4;

    if (entry.shortSummary && entry.shortSummary.trim() !== "") {
      doc.setFont("helvetica", "italic");
      var ssLines = doc.splitTextToSize(entry.shortSummary, maxWidth - 10);
      blockH += ssLines.length * lineHeight + 2;
    }
    if (entry.longSummary && entry.longSummary.trim() !== "") {
      doc.setFont("helvetica", "normal");
      var lsLines = doc.splitTextToSize(entry.longSummary, maxWidth - 10);
      blockH += lsLines.length * lineHeight + 2;
    }

    // Check if we need a new page (at least start the entry)
    if (y + Math.min(blockH, 40) > pageHeight - margin) {
      doc.addPage();
      y = margin;
    }

    // Citation (bold)
    doc.setFont("helvetica", "bold");
    doc.setFontSize(10);
    doc.text(citLines, margin, y);
    y += citLines.length * lineHeight + 1;

    // Short summary (italic)
    if (entry.shortSummary && entry.shortSummary.trim() !== "") {
      doc.setFont("helvetica", "italic");
      doc.setFontSize(9);
      var ssLines = doc.splitTextToSize(entry.shortSummary, maxWidth - 10);
      if (y + ssLines.length * lineHeight > pageHeight - margin) { doc.addPage(); y = margin; }
      doc.text(ssLines, margin + 5, y);
      y += ssLines.length * lineHeight + 1;
    }

    // Long summary
    if (entry.longSummary && entry.longSummary.trim() !== "") {
      doc.setFont("helvetica", "normal");
      doc.setFontSize(9);
      var lsLines = doc.splitTextToSize(entry.longSummary, maxWidth - 10);
      for (var li = 0; li < lsLines.length; li++) {
        if (y > pageHeight - margin) { doc.addPage(); y = margin; }
        doc.text(lsLines[li], margin + 5, y);
        y += lineHeight;
      }
      y += 1;
    }

    // Key quotations
    if (entry.quotations && entry.quotations.length > 0) {
      doc.setFont("helvetica", "normal");
      doc.setFontSize(8.5);
      for (var q = 0; q < entry.quotations.length; q++) {
        var qText = "\u201C" + entry.quotations[q].text + "\u201D";
        if (entry.quotations[q].page) qText += " (p. " + entry.quotations[q].page + ")";
        var qLines = doc.splitTextToSize(qText, maxWidth - 15);
        for (var ql = 0; ql < qLines.length; ql++) {
          if (y > pageHeight - margin) { doc.addPage(); y = margin; }
          doc.text(qLines[ql], margin + 10, y);
          y += lineHeight;
        }
      }
      y += 1;
    }

    // Editorial notes
    if (entry.editorialNotes && entry.editorialNotes.trim() !== "") {
      doc.setFont("helvetica", "italic");
      doc.setFontSize(8.5);
      var noteLines = doc.splitTextToSize("[Note: " + entry.editorialNotes + "]", maxWidth - 10);
      for (var nl = 0; nl < noteLines.length; nl++) {
        if (y > pageHeight - margin) { doc.addPage(); y = margin; }
        doc.text(noteLines[nl], margin + 5, y);
        y += lineHeight;
      }
      y += 1;
    }

    // Keywords
    if (entry.keywords && entry.keywords.length > 0) {
      doc.setFont("helvetica", "normal");
      doc.setFontSize(8);
      var kwStr = "Keywords: " + entry.keywords.join(", ");
      var kwLines = doc.splitTextToSize(kwStr, maxWidth - 10);
      if (y + kwLines.length * lineHeight > pageHeight - margin) { doc.addPage(); y = margin; }
      doc.text(kwLines, margin + 5, y);
      y += kwLines.length * lineHeight;
    }

    y += 6; // Space between entries
  }

  doc.save("bibliography_complete.pdf");
}

// --- INIT ---
// Handled by enterSite() after password check
</script>

</body>
</html>

index.html
Displaying index.html.
